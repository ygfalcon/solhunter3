"""Structured event models for the Golden Snapshot pipeline."""

from __future__ import annotations

from dataclasses import dataclass, field
from typing import Any, Dict, List, Optional, Sequence, Tuple


Timestamp = float

OHLCV_BAR_SCHEMA_VERSION = "2.0"
GOLDEN_SNAPSHOT_SCHEMA_VERSION = "2.0"
TOKEN_SNAPSHOT_SCHEMA_VERSION = "1.0"
DEPTH_SNAPSHOT_SCHEMA_VERSION = "1.0"
TRADE_SUGGESTION_SCHEMA_VERSION = "1.0"
DECISION_SCHEMA_VERSION = "1.0"
VIRTUAL_FILL_SCHEMA_VERSION = "1.0"
LIVE_FILL_SCHEMA_VERSION = "1.0"
TRADE_REJECTION_SCHEMA_VERSION = "1.0"
PRELIMINARY_SNAPSHOT_SCHEMA_VERSION = "1.0"


@dataclass(slots=True)
class DiscoveryCandidate:
    """Token identified by the discovery stage."""

    mint: str
    asof: Timestamp


@dataclass(slots=True)
class CandidateStats:
    liquidity_usd: float
    volume_1h_usd: float
    volume_24h_usd: float
    pair_age_min: float | None = None


@dataclass(slots=True)
class NormalizedCandidate:
    """Normalized discovery candidate consumed by the Phase-One pipeline."""

    mint: str
    symbol: str | None
    name: str | None
    decimals: int | None
    first_seen_at: str
    sources: Tuple[str, ...]
    stats: CandidateStats
    raw_payload_hash: str


@dataclass(slots=True)
class PreliminaryProvenance:
    sources: Tuple[str, ...]
    producer: Dict[str, str]


@dataclass(slots=True)
class PreliminarySnapshot:
    """Preliminary Golden snapshot emitted by Phase-One Stage-A."""

    mint: str
    symbol: str
    decimals: int
    asof: str
    px_mid_usd: float
    price_source: str
    staleness_ms: float
    liquidity_usd: float
    volume_1h_usd: float
    volume_24h_usd: float
    pair_age_min: float | None
    score: float
    provenance: PreliminaryProvenance
    idempotency_key: str
    price_confidence: float | None = None
    name: str | None = None
    schema_version: str = PRELIMINARY_SNAPSHOT_SCHEMA_VERSION


@dataclass(slots=True)
class TokenSnapshot:
    """Token metadata emitted by the enrichment stage."""

    mint: str
    symbol: str
    name: str
    decimals: int
    token_program: str
    venues: Sequence[str] | None = None
    flags: Dict[str, Any] = field(default_factory=dict)
    asof: Timestamp = 0.0
    schema_version: str = field(default=TOKEN_SNAPSHOT_SCHEMA_VERSION)


@dataclass(slots=True)
class TapeEvent:
    """Normalised swap or trade event from on-chain market data."""

    mint_base: str
    mint_quote: str
    amount_base: float
    amount_quote: float
    route: str
    program_id: str
    pool: str
    signer: str
    signature: str
    slot: int
    ts: Timestamp
    fees_base: float
    price_usd: float
    fees_usd: float
    is_self: bool = False
    buyer: Optional[str] = None


@dataclass(slots=True)
class OHLCVBar:
    """Closed 5-minute OHLCV bar."""

    mint: str
    open: float
    high: float
    low: float
    close: float
    vol_usd: float
    vol_base: float
    trades: int
    buyers: int
    flow_usd: float
    zret: float
    zvol: float
    asof_close: Timestamp
    schema_version: str = field(default=OHLCV_BAR_SCHEMA_VERSION)


@dataclass(slots=True)
class DepthSnapshot:
    """Executable depth snapshot for a token."""

    mint: str
    venue: str
    mid_usd: float
    spread_bps: float
    depth_pct: Dict[str, float]
    asof: Timestamp
    schema_version: str = field(default=DEPTH_SNAPSHOT_SCHEMA_VERSION)


@dataclass(slots=True)
class GoldenSnapshot:
    """Canonical input consumed by agents."""

    mint: str
    asof: Timestamp
    meta: Dict[str, Any]
    px: Dict[str, Any]
    liq: Dict[str, Any]
    ohlcv5m: Dict[str, Any]
    hash: str
    content_hash: str = ""
    idempotency_key: str = ""
    metrics: Dict[str, Any] = field(default_factory=dict)
    schema_version: str = field(default=GOLDEN_SNAPSHOT_SCHEMA_VERSION)


@dataclass(slots=True)
class TradeSuggestion:
    """Deterministic agent output derived from a Golden Snapshot."""

    agent: str
    mint: str
    side: str
    notional_usd: float
    max_slippage_bps: float
    risk: Dict[str, Any]
    confidence: float
    inputs_hash: str
    ttl_sec: float
    generated_at: Timestamp
    gating: Dict[str, Any] = field(default_factory=dict)
    slices: List[Dict[str, Any]] = field(default_factory=list)
    must_exit: bool = False
    hot_watch: bool = False
    exit_diagnostics: Dict[str, Any] = field(default_factory=dict)
    sequence: int = 0
    schema_version: str = field(default=TRADE_SUGGESTION_SCHEMA_VERSION)


@dataclass(slots=True)
class Decision:
    """Swarm-voted trading decision."""

    mint: str
    side: str
    notional_usd: float
    score: float
    snapshot_hash: str
    client_order_id: str
    agents: List[str]
    ts: Timestamp
    sequence: int = 0
    schema_version: str = field(default=DECISION_SCHEMA_VERSION)


@dataclass(slots=True)
class VirtualFill:
    """Synthetic fill generated by the shadow executor."""

    order_id: str
    mint: str
    side: str
    qty_base: float
    price_usd: float
    fees_usd: float
    slippage_bps: float
    snapshot_hash: str
    route: str
    ts: Timestamp
    schema_version: str = field(default=VIRTUAL_FILL_SCHEMA_VERSION)


@dataclass(slots=True)
class LiveFill:
    """Real fill generated by the live executor."""

    sig: str
    mint: str
    side: str
    qty_base: float
    price_usd: float
    fees_usd: float
    slippage_bps: float
    route: str
    snapshot_hash: str
    schema_version: str = field(default=LIVE_FILL_SCHEMA_VERSION)


@dataclass(slots=True)
class VirtualPnL:
    """Paper trading PnL derived from virtual fills."""

    order_id: str
    mint: str
    snapshot_hash: str
    realized_usd: float
    unrealized_usd: float
    ts: Timestamp

