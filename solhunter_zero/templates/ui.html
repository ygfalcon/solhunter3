
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SolHunter Zero Â· Swarm Console</title>
    <style>
        :root {
            color-scheme: dark;
            font-family: 'Inter', 'Segoe UI', sans-serif;
            --bg: #0d1117;
            --panel: rgba(20, 27, 36, 0.88);
            --border: rgba(88, 166, 255, 0.15);
            --accent: #58a6ff;
            --danger: #ff7b72;
            --warning: #f2cc60;
            --success: #3fb950;
            --muted: #8b949e;
        }
        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(circle at top, rgba(88,166,255,0.12), transparent 55%), var(--bg);
            color: #e6edf3;
            min-height: 100vh;
            line-height: 1.5;
        }
        body.handshake-pending .layout,
        body.handshake-pending .status-strip {
            opacity: 0;
            filter: blur(6px);
            pointer-events: none;
        }
        body.handshake-pending #handshake-layer {
            opacity: 1;
            visibility: visible;
        }
        body.handshake-complete #handshake-layer {
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        body.handshake-complete .layout,
        body.handshake-complete .status-strip {
            opacity: 1;
            filter: none;
            pointer-events: auto;
            transition: opacity 0.3s ease, filter 0.3s ease;
        }
        .handshake-layer {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(13,17,23,0.92);
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .handshake-card {
            background: rgba(20,27,36,0.95);
            border: 1px solid rgba(88,166,255,0.35);
            border-radius: 20px;
            padding: 32px 36px;
            width: min(420px, 92%);
            display: grid;
            gap: 18px;
            text-align: center;
            box-shadow: 0 26px 64px rgba(0,0,0,0.55);
        }
        .handshake-title {
            font-size: 1.6rem;
            font-weight: 600;
        }
        .handshake-meta {
            display: grid;
            gap: 10px;
            font-size: 0.92rem;
            color: var(--muted);
            text-align: left;
        }
        .handshake-meta div {
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }
        .handshake-meta dt {
            font-weight: 600;
            color: #e6edf3;
        }
        .handshake-meta dd {
            margin: 0;
        }
        .handshake-spinner {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 3px solid rgba(88,166,255,0.25);
            border-top-color: rgba(88,166,255,0.85);
            margin: 0 auto;
            animation: handshake-spin 1.2s linear infinite paused;
        }
        .handshake-spinner.active {
            animation-play-state: running;
        }
        @keyframes handshake-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .layout {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 24px 48px;
            display: grid;
            gap: 32px;
            grid-template-columns: 220px 1fr;
        }
        .nav-rail {
            position: sticky;
            top: 24px;
            align-self: flex-start;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(13,17,23,0.78);
            border: 1px solid rgba(88,166,255,0.2);
            border-radius: 20px;
            padding: 18px 16px;
            box-shadow: 0 18px 44px rgba(0,0,0,0.45);
        }
        .nav-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .nav-link {
            text-decoration: none;
            color: var(--muted);
            font-size: 0.92rem;
            padding: 8px 12px;
            border-radius: 12px;
            transition: background 0.2s ease, color 0.2s ease;
        }
        .nav-link:hover {
            color: #e6edf3;
            background: rgba(88,166,255,0.16);
        }
        .nav-link.active {
            color: #e6edf3;
            background: rgba(88,166,255,0.26);
            border: 1px solid rgba(88,166,255,0.42);
        }
        .main-column {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .status-strip {
            margin: 0 auto 24px;
            max-width: 1400px;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 16px;
            align-items: center;
            padding: 14px 20px;
            background: rgba(13,17,23,0.85);
            border: 1px solid rgba(88,166,255,0.18);
            border-radius: 16px;
            color: rgba(230,237,243,0.85);
            font-size: 0.9rem;
            box-shadow: 0 14px 32px rgba(0,0,0,0.38);
        }
        .status-strip div:last-child {
            font-variant-numeric: tabular-nums;
        }
        header {
            background: linear-gradient(160deg, rgba(20,27,36,0.92), rgba(12,16,24,0.9));
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            display: grid;
            gap: 20px;
            box-shadow: 0 20px 52px rgba(0,0,0,0.45);
        }
        header h1 {
            margin: 0;
            font-size: 1.9rem;
        }
        .connection-banner {
            border-radius: 20px;
            padding: 20px 24px;
            display: grid;
            gap: 16px;
            background: linear-gradient(135deg, rgba(27,38,54,0.95), rgba(12,18,28,0.92));
            border: 1px solid rgba(88,166,255,0.28);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
        }
        .connection-banner--connecting {
            border-color: rgba(88,166,255,0.28);
        }
        .connection-banner--ok {
            border-color: rgba(63,185,80,0.35);
        }
        .connection-banner--warning {
            border-color: rgba(242,204,96,0.4);
        }
        .connection-banner--error {
            border-color: rgba(255,123,114,0.45);
        }
        .system-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        .system-brand {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .brand-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .brand-subtitle {
            color: var(--muted);
            font-size: 0.85rem;
        }
        .system-meta {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .system-pill {
            font-weight: 600;
        }
        .connectivity-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 0.85rem;
            border: 1px solid rgba(88,166,255,0.35);
            background: rgba(13,17,23,0.72);
            transition: border-color 0.2s ease, color 0.2s ease;
        }
        .connectivity-pill .pill-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        .connectivity-pill.status-connecting {
            color: var(--accent);
        }
        .connectivity-pill.status-open {
            color: var(--success);
            border-color: rgba(63,185,80,0.45);
        }
        .connectivity-pill.status-warning {
            color: var(--warning);
            border-color: rgba(242,204,96,0.45);
        }
        .connectivity-pill.status-error {
            color: var(--danger);
            border-color: rgba(255,123,114,0.5);
        }
        .lag-strip {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }
        .lag-cell {
            background: rgba(13,17,23,0.65);
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid rgba(88,166,255,0.16);
            font-size: 0.85rem;
        }
        .lag-cell strong {
            display: block;
            margin-top: 6px;
            font-size: 1.05rem;
        }
        .connection-status-block {
            display: grid;
            gap: 6px;
        }
        @media (max-width: 960px) {
            .layout {
                grid-template-columns: 1fr;
            }
            .nav-rail {
                position: static;
                flex-direction: row;
                flex-wrap: wrap;
            }
            .nav-link {
                flex: 1 1 calc(50% - 8px);
                text-align: center;
            }
            .status-strip {
                grid-template-columns: 1fr;
                gap: 8px;
                text-align: left;
            }
        }
        .schema-banner {
            display: none;
            align-items: center;
            gap: 8px;
            border-radius: 12px;
            padding: 10px 14px;
            background: rgba(255,123,114,0.12);
            border: 1px solid rgba(255,123,114,0.35);
            color: var(--danger);
            font-size: 0.85rem;
        }
        .schema-banner.visible { display: flex; }
        .schema-banner code {
            background: rgba(0,0,0,0.35);
            padding: 2px 6px;
            border-radius: 6px;
            color: var(--muted);
        }
        .schema-banner .schema-detail {
            color: var(--muted);
            font-size: 0.78rem;
        }
        .connection-detail {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            color: var(--muted);
            font-size: 0.82rem;
            align-items: center;
        }
        .connection-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid rgba(88,166,255,0.2);
            background: rgba(13,17,23,0.72);
            line-height: 1.2;
        }
        .connection-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            opacity: 0.9;
            margin-right: 4px;
        }
        .connection-badge .badge-label {
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }
        .connection-badge .badge-detail {
            color: rgba(230, 237, 243, 0.65);
            font-size: 0.75rem;
        }
        .connection-badge.status-ok {
            border-color: rgba(63,185,80,0.4);
            color: var(--success);
        }
        .connection-badge.status-warn {
            border-color: rgba(242,204,96,0.45);
            color: var(--warning);
        }
        .connection-badge.status-danger {
            border-color: rgba(255,123,114,0.45);
            color: var(--danger);
        }
        .connection-badge.status-pending {
            border-color: rgba(88,166,255,0.35);
            color: var(--accent);
        }
        .connection-badge.status-idle {
            border-color: rgba(88,166,255,0.2);
            color: var(--muted);
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }
        .status-card {
            border-radius: 14px;
            padding: 14px;
            background: rgba(13,17,23,0.72);
            border: 1px solid rgba(88,166,255,0.12);
        }
        .status-card.ok { border-color: rgba(63,185,80,0.32); }
        .status-card.fail { border-color: rgba(255,123,114,0.32); }
        .status-card.warn { border-color: rgba(242,204,96,0.35); }
        .header-top {
            display: flex;
            justify-content: space-between;
            gap: 18px;
            flex-wrap: wrap;
        }
        .header-status-line {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin: 16px 0 10px;
        }
        .signal-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.82rem;
            background: rgba(13,17,23,0.72);
            border: 1px solid rgba(88,166,255,0.18);
            font-weight: 600;
        }
        .env-pill { text-transform: uppercase; letter-spacing: 0.04em; }
        .self-check-pill.status-ok { color: var(--success); border-color: rgba(63,185,80,0.45); }
        .self-check-pill.status-partial { color: var(--warning); border-color: rgba(242,204,96,0.45); }
        .self-check-pill.status-degraded { color: var(--danger); border-color: rgba(255,123,114,0.48); }
        .self-check-pill.status-failed { color: var(--danger); border-color: rgba(255,123,114,0.48); }
        .self-check-pill.status-running { color: var(--accent); border-color: rgba(88,166,255,0.35); }
        .self-check-pill.status-pending { color: var(--muted); }
        .signal-pill.env-dev { border-color: rgba(88,166,255,0.45); color: #58a6ff; }
        .signal-pill.env-STAGE, .signal-pill.env-stage { border-color: rgba(242,204,96,0.45); color: var(--warning); }
        .signal-pill.env-PROD, .signal-pill.env-prod { border-color: rgba(63,185,80,0.5); color: var(--success); }
        .signal-pill.toggle-on { border-color: rgba(63,185,80,0.5); color: var(--success); }
        .signal-pill.toggle-off { border-color: rgba(88,166,255,0.2); color: var(--muted); }
        .signal-pill.toggle-paused { border-color: rgba(255,123,114,0.55); color: var(--danger); }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .header-actions button {
            background: rgba(88,166,255,0.12);
            color: #e6edf3;
            border: 1px solid rgba(88,166,255,0.35);
            border-radius: 999px;
            padding: 8px 16px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .header-actions button:hover { background: rgba(88,166,255,0.22); }
        .signal-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }
        .signal-metric {
            background: rgba(13,17,23,0.6);
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid rgba(88,166,255,0.12);
        }
        #session-summary-panel .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        #session-summary-panel .summary-card {
            padding: 12px;
            border-radius: 12px;
            background: rgba(13,17,23,0.72);
            border: 1px solid rgba(88,166,255,0.12);
        }
        #session-summary-panel .summary-card strong {
            display: block;
            margin-top: 4px;
            font-size: 1.18rem;
        }
        #session-summary-panel .summary-card small {
            font-size: 0.75rem;
            color: var(--muted);
            margin-left: 4px;
        }
        #session-summary-panel .lag-grid {
            margin-top: 16px;
        }
        .color-chip {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .color-chip.ok { background: rgba(63,185,80,0.85); }
        .color-chip.warn { background: rgba(242,204,96,0.85); }
        .color-chip.danger { background: rgba(255,123,114,0.9); }
        .color-chip.idle { background: rgba(88,166,255,0.65); }
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            padding: 3px 10px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            border: 1px solid rgba(88,166,255,0.25);
            color: var(--muted);
        }
        .pill.stale { color: var(--danger); border-color: rgba(255,123,114,0.45); }
        .pill.fresh { color: var(--success); border-color: rgba(63,185,80,0.35); }
        .pill.pass { color: var(--success); border-color: rgba(63,185,80,0.35); }
        .pill.blocked { color: var(--danger); border-color: rgba(255,123,114,0.45); }
        .pill.neutral { color: var(--muted); border-color: rgba(110,118,129,0.35); }
        .pill.bid { color: var(--success); border-color: rgba(63,185,80,0.35); }
        .pill.ask { color: var(--danger); border-color: rgba(255,123,114,0.45); }
        .pill.depth { color: var(--muted); border-color: rgba(110,118,129,0.35); }
        .pill.source { font-weight: 600; border-color: rgba(88,166,255,0.35); }
        .pill.source.synthetic { border-color: rgba(242,204,96,0.45); color: var(--warning); }
        .pill.sentiment { border-color: rgba(88,166,255,0.35); letter-spacing: 0.08em; }
        .pill.sentiment.boosted { color: #f59e0b; border-color: rgba(245,158,11,0.5); }
        .pill.sentiment.baseline { color: var(--accent); border-color: rgba(88,166,255,0.45); }
        .sentiment-cell { display: flex; flex-direction: column; gap: 4px; }
        .sentiment-cell small { font-size: 12px; color: var(--muted); }
        .pill.faded { opacity: 0.6; }
        .price-wrapper { display: flex; gap: 0.35rem; align-items: center; flex-wrap: wrap; }
        .depth-group { display: flex; gap: 0.35rem; flex-wrap: wrap; }
        .depth-meta { font-size: 0.7rem; margin-top: 0.25rem; }
        .mid-price { font-weight: 600; }
        .grid-two {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 24px;
        }
        .panel {
            background: var(--panel);
            border-radius: 18px;
            border: 1px solid var(--border);
            padding: 18px 20px 22px;
            box-shadow: 0 14px 38px rgba(0,0,0,0.35);
        }
        .panel.skeleton::after {
            content: "";
            display: block;
            height: 4px;
            margin-top: 12px;
            background: linear-gradient(90deg, rgba(88,166,255,0.1), rgba(88,166,255,0.35), rgba(88,166,255,0.1));
            background-size: 200% 100%;
            animation: shimmer 1.4s infinite;
            border-radius: 4px;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .panel h2 {
            margin-top: 0;
            font-size: 1.25rem;
            letter-spacing: 0.02em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 0.92rem;
        }
        th, td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(88,166,255,0.08);
        }
        th { text-align: left; font-weight: 500; color: rgba(230,237,243,0.75); }
        tbody tr:hover { background: rgba(88,166,255,0.06); }
        tbody tr.stale { background: rgba(255,123,114,0.06); }
        .muted { color: var(--muted); }
        .momentum-cell { min-width: 150px; }
        .momentum-bar {
            position: relative;
            height: 7px;
            border-radius: 999px;
            background: rgba(88,166,255,0.12);
            overflow: hidden;
        }
        .momentum-bar .fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, rgba(31,146,63,0.85) 0%, rgba(242,204,96,0.9) 50%, rgba(217,56,30,0.9) 100%);
            border-radius: inherit;
            transition: width 0.25s ease;
        }
        .momentum-bar.stale { opacity: 0.35; }
        .momentum-bar .momentum-indicator {
            position: absolute;
            right: 4px;
            top: -4px;
            font-size: 0.7rem;
        }
        .momentum-value {
            font-size: 0.72rem;
            margin-top: 4px;
            color: rgba(230,237,243,0.85);
        }
        .momentum-breakdown { margin-top: 6px; }
        .momentum-breakdown summary {
            cursor: pointer;
            font-size: 0.72rem;
            color: var(--muted);
            list-style: none;
        }
        .momentum-breakdown summary::-webkit-details-marker { display: none; }
        .momentum-card {
            margin-top: 6px;
            background: rgba(13,17,23,0.75);
            border: 1px solid rgba(88,166,255,0.12);
            border-radius: 10px;
            padding: 10px 12px;
            display: grid;
            gap: 6px;
        }
        .momentum-card div {
            display: flex;
            justify-content: space-between;
            font-size: 0.74rem;
            color: rgba(230,237,243,0.82);
        }
        .momentum-card span { color: var(--muted); }
        .momentum-card strong { font-weight: 600; }
        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        .metrics {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 12px;
        }
        .metric {
            background: rgba(13,17,23,0.72);
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid rgba(88,166,255,0.12);
            min-width: 140px;
        }
        .metric strong { display: block; font-size: 1.1rem; }
        .badge-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }
        .filter-bar input,
        .filter-bar select {
            background: rgba(13,17,23,0.6);
            border: 1px solid rgba(88,166,255,0.18);
            border-radius: 8px;
            padding: 6px 10px;
            color: #e6edf3;
        }
        .mint-chip {
            color: var(--accent);
            font-weight: 600;
            text-decoration: none;
        }
        .mint-chip:hover { text-decoration: underline; }
        .decision-card {
            position: relative;
        }
        .decision-card .badge {
            position: absolute;
            top: 8px;
            right: 10px;
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid rgba(88,166,255,0.25);
        }
        .badge.ok { color: var(--success); border-color: rgba(63,185,80,0.35); }
        .badge.warn { color: var(--warning); border-color: rgba(242,204,96,0.35); }
        .badge.danger { color: var(--danger); border-color: rgba(255,123,114,0.45); }
        .test-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(13,17,23,0.72);
            border: 1px solid rgba(88,166,255,0.2);
            font-size: 0.78rem;
        }
        .test-indicator.ok { border-color: rgba(63,185,80,0.45); color: var(--success); }
        .test-indicator.waiting { color: var(--warning); border-color: rgba(242,204,96,0.45); }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        .control-card {
            border-radius: 14px;
            padding: 14px;
            background: rgba(13,17,23,0.72);
            border: 1px solid rgba(88,166,255,0.12);
        }
        .control-card strong { display: block; margin-bottom: 6px; }
        .stack {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .decision-tape {
            margin-top: 12px;
            display: grid;
            gap: 10px;
        }
        .decision-card {
            padding: 12px;
            border-radius: 12px;
            background: rgba(13,17,23,0.72);
            border: 1px solid rgba(88,166,255,0.1);
        }
        .decision-card.duplicate { border-color: rgba(255,123,114,0.4); }
        @media (max-width: 720px) {
            .layout { padding: 18px 14px 40px; }
            header { padding: 18px; }
            .panel { padding: 16px; }
        }
        .highlight {
            outline: 2px solid var(--accent);
            transition: outline 0.4s ease;
        }
    </style>
</head>
<body class="handshake-pending">
    <div id="handshake-layer" class="handshake-layer">
        <div class="handshake-card" role="status" aria-live="polite">
            <div class="handshake-title">SolHunter Operations Console</div>
            <div class="handshake-spinner" id="handshake-spinner" aria-hidden="true"></div>
            <dl class="handshake-meta">
                <div><dt>Broker</dt><dd id="handshake-broker">Resolvingâ¦</dd></div>
                <div><dt>Channel</dt><dd id="handshake-channel">â</dd></div>
                <div><dt>Client</dt><dd id="handshake-client">UI v{{ ui_schema_version }}</dd></div>
                <div><dt>Runtime</dt><dd id="handshake-runtime">Negotiatingâ¦</dd></div>
            </dl>
            <p id="handshake-status">Waiting for UI_META handshakeâ¦</p>
        </div>
    </div>
    <div class="layout">
        <nav class="nav-rail" aria-label="Primary">
            <div class="nav-group">
                <a class="nav-link active" href="#overview" data-target="overview">Overview</a>
                <a class="nav-link" href="#discovery" data-target="discovery">Discovery</a>
                <a class="nav-link" href="#market-panel" data-target="market">Market</a>
                <a class="nav-link" href="#golden-panel" data-target="golden">Golden</a>
                <a class="nav-link" href="#suggestions-panel" data-target="agents">Agents</a>
                <a class="nav-link" href="#vote-panel" data-target="execution">Execution</a>
                <a class="nav-link" href="#diagnostics-panel" data-target="diagnostics">Diagnostics</a>
                <a class="nav-link" href="#settings-panel" data-target="settings">Settings</a>
            </div>
        </nav>
        <div class="main-column">
        <header id="overview">
            <div id="connection-banner" class="connection-banner connection-banner--connecting"
                data-bus-lag="{{ header_signals.bus_latency_ms | default('', true) }}"
                data-ohlcv-lag="{{ header_signals.stream_lag.ohlcv | default('', true) }}"
                data-depth-lag="{{ header_signals.stream_lag.depth | default('', true) }}"
                data-golden-lag="{{ golden_lag_value | default('', true) }}"
                data-agents-stale="{{ '1' if agent_is_stale else '0' }}"
                data-agents-age="{{ agent_age_label }}">
                <div class="system-bar">
                    <div class="system-brand">
                        <span class="brand-title">SolHunter Zero</span>
                        <span class="brand-subtitle">Operations Console</span>
                    </div>
                    <div class="system-meta">
                        <span class="system-pill signal-pill env-{{ header_signals.environment|lower() }}">{{ header_signals.environment }}</span>
                        <span id="connectivity-pill" class="connectivity-pill status-connecting" role="status">
                            <span class="pill-dot" aria-hidden="true"></span>
                            <span class="pill-label">Connectingâ¦</span>
                        </span>
                    </div>
                </div>
                <div class="lag-strip">
                    <div class="lag-cell">
                        <span>Bus Lag</span>
                        <strong id="lag-bus-top">{{ header_signals.bus_latency_ms | round(1) if header_signals.bus_latency_ms is not none else 'â' }} ms</strong>
                    </div>
                    <div class="lag-cell">
                        <span>Depth Lag</span>
                        <strong id="lag-depth-top">{{ header_signals.stream_lag.depth | round(1) if header_signals.stream_lag.depth is not none else 'â' }} ms</strong>
                    </div>
                    <div class="lag-cell">
                        <span>Golden Lag</span>
                        <strong id="lag-golden-top">{{ header_signals.stream_lag.golden | round(1) if header_signals.stream_lag.golden is not none else 'â' }} ms</strong>
                    </div>
                </div>
                <div class="connection-status-block">
                    <strong id="connection-status-label">Connecting to runtimeâ¦</strong>
                    <div id="connection-status-detail" class="connection-detail">
                        {% if connection_badges %}
                        {% for badge in connection_badges %}
                        <span class="connection-badge {{ badge.css_class }}" data-channel="{{ badge.name }}" data-status="{{ badge.status }}">
                            <span class="badge-label">{{ badge.label }}</span>
                            {% if badge.detail %}
                            <span class="badge-detail">{{ badge.detail }}</span>
                            {% endif %}
                        </span>
                        {% endfor %}
                        {% else %}
                        <span class="muted">Fetching runtime metadataâ¦</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div id="schema-banner" class="schema-banner" role="alert">
                <strong id="schema-banner-title">Schema status</strong>
                <span id="schema-banner-detail" class="schema-detail"></span>
            </div>
            <div class="header-top">
                <div class="section-title">
                    <h1>SolHunter Swarm Lifecycle</h1>
                    <span class="pill {{ 'fresh' if not swarm_overall.get('stale') else 'stale' }}">
                        Updated {{ swarm_overall.get('age_label', 'n/a') }}
                    </span>
                </div>
                <div class="header-actions">
                    <button id="golden-demo-button" type="button">Run Golden Demo</button>
                </div>
            </div>
            <div class="header-status-line">
                <span id="environment-pill" class="signal-pill env-pill">ð Env {{ header_signals.environment }}</span>
                <span id="paper-pill" class="signal-pill {{ 'toggle-on' if header_signals.paper_mode else 'toggle-off' }}">ð Paper {{ 'ON' if header_signals.paper_mode else 'OFF' }}</span>
                <span id="rl-pill" class="signal-pill">ð¤ RL {{ header_signals.rl_label }}</span>
                {% set sc = header_signals.self_check or {} %}
                {% set sc_status = sc.get('status', 'pending') %}
                <span id="self-check-pill" class="signal-pill self-check-pill status-{{ sc_status }}">Self-check: {{ sc_status|upper() }}</span>
            </div>
            <div class="signal-metrics">
                <div class="signal-metric">
                    <span class="muted">Bus Latency</span>
                    <strong>{{ header_signals.bus_latency_ms | round(1) if header_signals.bus_latency_ms is not none else 'â' }} ms</strong>
                </div>
                <div class="signal-metric">
                    <span class="muted">OHLCV Lag</span>
                    <strong>{{ header_signals.stream_lag.ohlcv | round(1) if header_signals.stream_lag.ohlcv is not none else 'â' }} ms</strong>
                </div>
                <div class="signal-metric">
                    <span class="muted">Depth Lag</span>
                    <strong>{{ header_signals.stream_lag.depth | round(1) if header_signals.stream_lag.depth is not none else 'â' }} ms</strong>
                </div>
                <div class="signal-metric">
                    <span class="muted">Golden Lag</span>
                    <strong>{{ header_signals.stream_lag.golden | round(1) if header_signals.stream_lag.golden is not none else 'â' }} ms</strong>
                </div>
            </div>
            <div class="metrics">
                <div class="metric">
                    <span class="muted">Suggestions / 5m</span>
                    <strong>{{ kpis.suggestions_per_5m | round(2) }}</strong>
                </div>
                <div class="metric">
                    <span class="muted">Acceptance</span>
                    <strong>{{ (kpis.acceptance_rate * 100) | round(1) }}%</strong>
                </div>
                <div class="metric">
                    <span class="muted">Golden Hashes</span>
                    <strong>{{ kpis.golden_hashes }}</strong>
                </div>
                <div class="metric">
                    <span class="muted">Open Vote Windows</span>
                    <strong>{{ kpis.open_windows }}</strong>
                </div>
                <div class="metric">
                    <span class="muted">Paper PnL (1D)</span>
                    <strong>{{ kpis.paper_pnl | round(2) if kpis.paper_pnl is not none else 'â' }}</strong>
                </div>
                <div class="metric">
                    <span class="muted">Drawdown</span>
                    <strong>{{ (kpis.drawdown * 100) | round(2) if kpis.drawdown is not none else 'â' }}%</strong>
                </div>
                <div class="metric">
                    <span class="muted">Turnover</span>
                    <strong>{{ kpis.turnover | round(2) if kpis.turnover is not none else 'â' }}</strong>
                </div>
            </div>
            <div class="status-grid">
                {% for card in status_cards %}
                <div class="status-card {{ card.state }}">
                    <div>{{ card.label }}</div>
                    <div class="muted">{{ card.caption }}</div>
                </div>
                {% endfor %}
            </div>
        </header>

        {% set summary_state = 'warn' if swarm_overall.get('stale') else 'ok' %}
        <section class="panel" id="session-summary-panel">
            <div class="section-title">
                <h2><span class="color-chip {{ summary_state }}"></span>Session Summary</h2>
                <span class="muted">Last update {{ swarm_overall.get('age_label', 'n/a') }}</span>
            </div>
            <div class="summary-grid">
                <div class="summary-card">
                    <span class="muted">Suggestions / 5m</span>
                    {% if session_summary.suggestions_5m is not none %}
                    <strong>{{ session_summary.suggestions_5m | round(2) }}</strong>
                    {% else %}
                    <strong>â</strong>
                    {% endif %}
                </div>
                <div class="summary-card">
                    <span class="muted">Acceptance Rate</span>
                    {% if session_summary.acceptance_rate is not none %}
                    <strong>{{ (session_summary.acceptance_rate * 100) | round(1) }}%</strong>
                    {% else %}
                    <strong>â</strong>
                    {% endif %}
                </div>
                <div class="summary-card">
                    <span class="muted">Golden Hashes</span>
                    {% if session_summary.golden_hashes is not none %}
                    <strong>{{ session_summary.golden_hashes }}</strong>
                    {% else %}
                    <strong>â</strong>
                    {% endif %}
                </div>
                <div class="summary-card">
                    <span class="muted">Shadow Fills</span>
                    {% if session_summary.shadow_fills is not none %}
                    <strong>{{ session_summary.shadow_fills }}</strong>
                    {% else %}
                    <strong>â</strong>
                    {% endif %}
                </div>
                <div class="summary-card">
                    <span class="muted">Open Vote Windows</span>
                    {% if session_summary.open_vote_windows is not none %}
                    <strong>{{ session_summary.open_vote_windows }}</strong>
                    {% else %}
                    <strong>â</strong>
                    {% endif %}
                </div>
                <div class="summary-card">
                    <span class="muted">Paper Unrealized</span>
                    {% if session_summary.paper_unrealized_usd is not none %}
                    <strong>{{ session_summary.paper_unrealized_usd | round(2) }}<small>USD</small></strong>
                    {% else %}
                    <strong>â</strong>
                    {% endif %}
                </div>
            </div>
            <div class="summary-grid lag-grid">
                <div class="summary-card">
                    <span class="muted">Bus Lag</span>
                    {% if session_summary.lag_bus_ms is not none %}
                    <strong>{{ session_summary.lag_bus_ms | round(1) }} ms</strong>
                    {% else %}
                    <strong>â</strong>
                    {% endif %}
                </div>
                <div class="summary-card">
                    <span class="muted">OHLCV Lag</span>
                    {% if session_summary.lag_ohlcv_ms is not none %}
                    <strong>{{ session_summary.lag_ohlcv_ms | round(1) }} ms</strong>
                    {% else %}
                    <strong>â</strong>
                    {% endif %}
                </div>
                <div class="summary-card">
                    <span class="muted">Depth Lag</span>
                    {% if session_summary.lag_depth_ms is not none %}
                    <strong>{{ session_summary.lag_depth_ms | round(1) }} ms</strong>
                    {% else %}
                    <strong>â</strong>
                    {% endif %}
                </div>
                <div class="summary-card">
                    <span class="muted">Golden Lag</span>
                    {% if session_summary.lag_golden_ms is not none %}
                    <strong>{{ session_summary.lag_golden_ms | round(1) }} ms</strong>
                    {% else %}
                    <strong>â</strong>
                    {% endif %}
                </div>
            </div>
        </section>

        <section class="grid-two" id="discovery">
            <article class="panel" id="discovery-panel">
                {% set discovery_stale = discovery_console.candidates | selectattr('stale') | list %}
                {% set discovery_state = 'idle' %}
                {% if discovery_console.candidates %}
                    {% if discovery_stale|length == discovery_console.candidates|length %}
                        {% set discovery_state = 'danger' %}
                    {% elif discovery_stale %}
                        {% set discovery_state = 'warn' %}
                    {% else %}
                        {% set discovery_state = 'ok' %}
                    {% endif %}
                {% endif %}
                <div class="section-title">
                    <h2><span class="color-chip {{ discovery_state }}"></span>Discovery Console</h2>
                    <span class="muted">{{ discovery_console.stats.total }} candidates</span>
                    <span class="preflight-result" data-preflight-panel="discovery">â³</span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Mint</th>
                            <th>Score</th>
                            <th>Source</th>
                            <th>Observed</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in discovery_console.candidates %}
                        <tr class="{{ 'stale' if row.stale else '' }}" data-mint="{{ row.mint }}">
                            <td>{{ row.mint }}</td>
                            <td>{{ row.score if row.score is not none else 'â' }}</td>
                            <td>
                                {% if row.sources %}
                                <span title="{{ row.sources | join(', ') }}">{{ row.source or row.sources[0] }}</span>
                                {% else %}
                                {{ row.source or 'â' }}
                                {% endif %}
                            </td>
                            <td>
                                {{ row.asof or 'â' }}
                                <span class="pill {{ 'stale' if row.stale else 'fresh' }}">{{ row.age_label }}</span>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="muted">Waiting for discovery streamâ¦</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </article>

            <article class="panel" id="token-facts-panel">
                {% set token_stale = token_facts.tokens.values() | selectattr('stale') | list %}
                {% set token_state = 'idle' %}
                {% if token_facts.tokens %}
                    {% if token_stale|length == token_facts.tokens|length %}
                        {% set token_state = 'danger' %}
                    {% elif token_stale %}
                        {% set token_state = 'warn' %}
                    {% else %}
                        {% set token_state = 'ok' %}
                    {% endif %}
                {% endif %}
                <div class="section-title">
                    <h2><span class="color-chip {{ token_state }}"></span>Token Facts Drawer</h2>
                    <span class="muted">{{ token_facts.tokens | length }} loaded</span>
                    <span class="preflight-result" data-preflight-panel="token-facts">â³</span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Mint</th>
                            <th>Symbol</th>
                            <th>Venues</th>
                            <th>As Of</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mint, info in token_facts.tokens.items() %}
                        <tr class="{{ 'stale' if info.stale else '' }}" data-mint="{{ mint }}">
                            <td>{{ mint }}</td>
                            <td>{{ info.symbol or 'â' }}</td>
                            <td>{{ info.venues | join(', ') if info.venues else 'â' }}</td>
                            <td>{{ info.asof or 'â' }} <span class="pill {{ 'stale' if info.stale else 'fresh' }}">{{ info.age_label }}</span></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="muted">No token snapshots yet.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </article>
        </section>

        <section class="grid-two">
            <article class="panel" id="market-panel">
                {% set market_stale = market_state.markets | selectattr('stale') | list %}
                {% set market_state_flag = 'idle' %}
                {% if market_state.markets %}
                    {% if market_stale|length == market_state.markets|length %}
                        {% set market_state_flag = 'danger' %}
                    {% elif market_stale %}
                        {% set market_state_flag = 'warn' %}
                    {% else %}
                        {% set market_state_flag = 'ok' %}
                    {% endif %}
                {% endif %}
                <div class="section-title">
                    <h2><span class="color-chip {{ market_state_flag }}"></span>Market Â· OHLCV & Depth</h2>
                    <span class="muted">{{ market_state.markets | length }} tracked</span>
                    <span class="preflight-result" data-preflight-panel="market">â³</span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Mint</th>
                            <th>Close</th>
                            <th>Volume</th>
                            <th>Spread</th>
                            <th>Depth 1%</th>
                            <th>Lag (ms)</th>
                            <th>Updated</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for market in market_state.markets %}
                        <tr class="{{ 'stale' if market.stale else '' }}" data-mint="{{ market.mint }}">
                            <td>{{ market.mint }}</td>
                            <td>{{ market.close or 'â' }}</td>
                            <td>{{ market.volume or 'â' }}</td>
                            <td>{{ market.spread_bps or 'â' }}</td>
                            <td>{{ market.depth_pct.get('1') if market.depth_pct else 'â' }}</td>
                            <td>
                                <span class="pill {{ 'stale' if market.stale else 'fresh' }}">OHLCV {{ market.lag_close_ms | round(0) if market.lag_close_ms is not none else 'â' }}</span>
                                <span class="pill {{ 'stale' if market.stale else 'fresh' }}">Depth {{ market.lag_depth_ms | round(0) if market.lag_depth_ms is not none else 'â' }}</span>
                            </td>
                            <td>{{ market.updated_label }}</td>
                        </tr>
                        {% else %}
                        <tr class="skeleton-row"><td colspan="7" class="muted">Waiting for market stateâ¦</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </article>

            <article class="panel" id="golden-panel">
                {% set golden_stale = golden_snapshots | selectattr('stale') | list %}
                {% set golden_state = 'idle' %}
                {% if golden_snapshots %}
                    {% if golden_stale|length == golden_snapshots|length %}
                        {% set golden_state = 'danger' %}
                    {% elif golden_stale %}
                        {% set golden_state = 'warn' %}
                    {% else %}
                        {% set golden_state = 'ok' %}
                    {% endif %}
                {% endif %}
                <div class="section-title">
                    <h2><span class="color-chip {{ golden_state }}"></span>Golden Snapshot Inspector</h2>
                    <span class="muted">{{ golden_summary.count }} hashes</span>
                    <span class="preflight-result" data-preflight-panel="golden">â³</span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Mint</th>
                            <th>Hash</th>
                            <th>Price</th>
                            <th>Liquidity</th>
                            {% if golden_momentum_enabled %}
                            <th>Momentum</th>
                            {% endif %}
                            <th>Sentiment</th>
                            <th>Lag (ms)</th>
                            <th>Published</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for snap in golden_snapshots %}
                        <tr class="{{ 'stale' if snap.stale else '' }}" data-mint="{{ snap.mint }}">
                            <td>{{ snap.mint }}</td>
                            <td class="muted">{{ snap.hash_short }}</td>
                            <td>
                                {% if golden_depth_enabled %}
                                    <div class="price-wrapper">
                                        <span class="mid-price">{{ snap.px | round(4) if snap.px is not none else 'â' }}</span>
                                        {% if snap.px_bid_usd is not none %}
                                            <span class="pill bid {{ 'faded' if snap.degraded else '' }}">Bid {{ snap.px_bid_usd | round(4) }}</span>
                                        {% endif %}
                                        {% if snap.px_ask_usd is not none %}
                                            <span class="pill ask {{ 'faded' if snap.degraded else '' }}">Ask {{ snap.px_ask_usd | round(4) }}</span>
                                        {% endif %}
                                        {% if snap.source %}
                                            {% set badge = 'J' if snap.source == 'jup_route' else 'P' %}
                                            {% if snap.source == 'jup_route' %}
                                                {% set sweeps = snap.route_meta.sweeps if snap.route_meta and snap.route_meta.sweeps else [] %}
                                                {% if sweeps %}
                                                    {% set sweep_tooltip = namespace(parts=[]) %}
                                                    {% for sweep in sweeps %}
                                                        {% set direction = sweep.direction if sweep.direction is not none else 'sell' %}
                                                        {% set label = direction[0]|upper ~ direction[1:] if direction else 'Sweep' %}
                                                        {% set usd_val = sweep.usd if sweep.usd is not none else 0 %}
                                                        {% set impact_val = sweep.impact_bps if sweep.impact_bps is not none else 0 %}
                                                        {% set sweep_tooltip.parts = sweep_tooltip.parts + [label ~ ' $' ~ (usd_val|round(0)) ~ ' @ ' ~ (impact_val|round(2)) ~ ' bps'] %}
                                                    {% endfor %}
                                                    {% set tooltip = 'Routed sweeps: ' ~ (sweep_tooltip.parts | join('; ')) %}
                                                {% else %}
                                                    {% set tooltip = 'Routed depth via Jupiter' %}
                                                {% endif %}
                                            {% else %}
                                                {% set spread = None %}
                                                {% if snap.px is not none and snap.px_bid_usd is not none and snap.px_ask_usd is not none and snap.px > 0 %}
                                                    {% set spread = ((snap.px_ask_usd - snap.px_bid_usd) / snap.px) * 10000 %}
                                                {% endif %}
                                                {% if spread is not none %}
                                                    {% set tooltip = 'Synthetic Â±' ~ (spread|round(2)) ~ ' bps (Pyth confidence)' %}
                                                {% else %}
                                                    {% set tooltip = 'Synthetic spread derived from oracle confidence' %}
                                                {% endif %}
                                            {% endif %}
                                            <span class="pill source {{ 'synthetic' if snap.source != 'jup_route' else '' }}" title="{{ tooltip }}">{{ badge }}</span>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    {{ snap.px or 'â' }}
                                {% endif %}
                            </td>
                            <td>
                                {% if golden_depth_enabled %}
                                    <div class="depth-group">
                                        <span class="pill depth" title="Liquidity available within 10 bps">0.1% {{ snap.liq_depth_0_1pct_usd | round(0) if snap.liq_depth_0_1pct_usd is not none else 'â' }}</span>
                                        <span class="pill depth" title="Liquidity available within 50 bps">0.5% {{ snap.liq_depth_0_5pct_usd | round(0) if snap.liq_depth_0_5pct_usd is not none else 'â' }}</span>
                                        <span class="pill depth" title="Liquidity available within 100 bps">1% {{ snap.liq_depth_1_0pct_usd | round(0) if snap.liq_depth_1_0pct_usd is not none else 'â' }}</span>
                                    </div>
                                    {% if snap.route_meta %}
                                        <div class="muted depth-meta">Route: {{ snap.route_meta.dexes | join(' â ') if snap.route_meta.dexes else 'â' }} Â· {{ snap.route_meta.hops }} hops{% if snap.route_meta.latency_ms is not none %} Â· Adapter {{ snap.route_meta.latency_ms | round(0) }} ms{% endif %}</div>
                                    {% endif %}
                                {% else %}
                                    {{ snap.liq or 'â' }}
                                {% endif %}
                            </td>
                            {% if golden_momentum_enabled %}
                            <td class="momentum-cell">
                                {% set momentum_score = snap.momentum_score %}
                                <div class="momentum-bar {{ 'stale' if snap.momentum_stale else '' }}" title="Composite momentum from liquidity rank, short-horizon price velocity, Pump.fun heat, and social mentions; updated ~60 seconds; lower is cooler, higher is hotter.">
                                    <div class="fill" style="width: {{ ((momentum_score or 0) * 100) | round(1) }}%;"></div>
                                    {% if snap.momentum_stale %}<span class="momentum-indicator">â±</span>{% endif %}
                                </div>
                                <div class="momentum-value">{{ momentum_score | round(3) if momentum_score is not none else 'â'}}</div>
                                {% set breakdown = snap.momentum_breakdown or {} %}
                                {% if breakdown or snap.momentum_sources or snap.momentum_partial or snap.social_score is not none %}
                                <details class="momentum-breakdown">
                                    <summary>Breakdown</summary>
                                    <div class="momentum-card">
                                        {% set vol1 = breakdown.get('volume_rank_1h') %}
                                        {% set vol1_raw = breakdown.get('volume_1h_usd_raw') %}
                                        <div>
                                            <span>Vol 1h</span><strong>{{ vol1 | round(3) if vol1 is not none else 'â' }}</strong>
                                            {% if vol1_raw is not none %}<small class="raw">Raw {{ vol1_raw | round(0) }}</small>{% endif %}
                                        </div>
                                        {% set price5 = breakdown.get('price_momentum_5m') %}
                                        {% set price5_raw = breakdown.get('price_change_5m_raw') %}
                                        <div>
                                            <span>Price 5m</span><strong>{{ price5 | round(3) if price5 is not none else 'â' }}</strong>
                                            {% if price5_raw is not none %}<small class="raw">Î {{ price5_raw | round(3) }}%</small>{% endif %}
                                        </div>
                                        {% set price1 = breakdown.get('price_momentum_1h') %}
                                        {% set price1_raw = breakdown.get('price_change_1h_raw') %}
                                        <div>
                                            <span>Price 1h</span><strong>{{ price1 | round(3) if price1 is not none else 'â' }}</strong>
                                            {% if price1_raw is not none %}<small class="raw">Î {{ price1_raw | round(3) }}%</small>{% endif %}
                                        </div>
                                        {% set pump = breakdown.get('pump_intensity') %}
                                        {% set pump_raw = breakdown.get('pump_score_raw') %}
                                        {% set pump_rank_raw = breakdown.get('pump_rank_raw') %}
                                        {% set buyers_raw = breakdown.get('buyers_last_hour_raw') %}
                                        <div>
                                            <span>Pump</span><strong>{{ pump | round(3) if pump is not none else 'â' }}</strong>
                                            {% if pump_raw is not none or pump_rank_raw is not none or buyers_raw is not none %}
                                            <small class="raw">
                                                {% if pump_raw is not none %}Score {{ pump_raw | round(3) }}{% endif %}
                                                {% if pump_rank_raw is not none %}{% if pump_raw is not none %} Â· {% endif %}Rank {{ pump_rank_raw }}{% endif %}
                                                {% if buyers_raw is not none %}{% if pump_raw is not none or pump_rank_raw is not none %} Â· {% endif %}Buyers {{ buyers_raw | round(0) }}{% endif %}
                                            </small>
                                            {% endif %}
                                        </div>
                                        {% set tweets = breakdown.get('tweets_per_min') %}
                                        {% set tweets_raw = breakdown.get('tweets_per_min_raw') %}
                                        <div>
                                            <span>Tweets/min</span><strong>{{ tweets | round(3) if tweets is not none else 'â'}}</strong>
                                            {% if tweets_raw is not none %}<small class="raw">Raw {{ tweets_raw | round(3) }}</small>{% endif %}
                                        </div>
                                        {% set social_sent = snap.social_sentiment if snap.social_sentiment is not none else breakdown.get('social_sentiment') %}
                                        {% set community_score = breakdown.get('community_score') %}
                                        <div>
                                            <span>Social Sent.</span><strong>{{ social_sent | round(3) if social_sent is not none else 'â' }}</strong>
                                            {% if community_score is not none %}<small class="raw">Community {{ community_score | round(3) }}</small>{% endif %}
                                        </div>
                                        {% set social_score = snap.social_score if snap.social_score is not none else breakdown.get('social_score') %}
                                        <div><span>Social Score</span><strong>{{ social_score | round(3) if social_score is not none else 'â' }}</strong></div>
                                        {% set buyers = breakdown.get('buyers_last_hour') %}
                                        <div><span>Buyers (1h)</span><strong>{{ buyers if buyers is not none else 'â' }}</strong></div>
                                        {% if breakdown.get('social_source') %}
                                            <div><span>Social Source</span><strong>{{ breakdown.get('social_source') }}</strong></div>
                                        {% endif %}
                                        {% set errors = breakdown.get('error_hosts') %}
                                        {% if errors %}
                                            <div><span>Errors</span><strong>{{ errors | join(', ') if errors is iterable else errors }}</strong></div>
                                        {% endif %}
                                        <div><span>Sources</span><strong>{{ snap.momentum_sources | join(', ') if snap.momentum_sources else 'â' }}</strong></div>
                                        {% if snap.momentum_partial %}
                                            <div><span>Coverage</span><strong>Partial</strong></div>
                                        {% endif %}
                                        {% if snap.momentum_latency_ms is not none %}
                                            <div><span>Latency</span><strong>{{ snap.momentum_latency_ms | round(1) }} ms</strong></div>
                                        {% endif %}
                                    </div>
                                </details>
                                {% endif %}
                            </td>
                            {% endif %}
                            <td class="sentiment-cell">
                                {% if snap.sentiment_label %}
                                    <span class="pill sentiment {{ snap.sentiment_class or 'baseline' }}">{{ snap.sentiment_label }}</span>
                                {% elif snap.social_sentiment is not none %}
                                    <span class="pill sentiment baseline">{{ snap.social_sentiment | round(3) }}</span>
                                {% else %}
                                    â
                                {% endif %}
                                {% if snap.social_sentiment is not none %}
                                    <small>Score {{ snap.social_sentiment | round(3) }}</small>
                                {% endif %}
                                {% if snap.sentiment_source %}
                                    <small>{{ snap.sentiment_source }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="pill {{ 'stale' if snap.stale else 'fresh' }}">{{ snap.lag_ms | round(0) if snap.lag_ms is not none else 'â' }}</span>
                            </td>
                            <td>{{ snap.age_label }}</td>
                        </tr>
                        {% else %}
                        <tr class="skeleton-row"><td colspan="{{ 8 if golden_momentum_enabled else 7 }}" class="muted">Golden pipeline idle.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </article>
        </section>

        <section class="grid-two">
            <article class="panel" id="suggestions-panel">
                {% set suggestion_stale = suggestions.suggestions | selectattr('stale') | list %}
                {% set mismatch = suggestions.suggestions | selectattr('hash_mismatch') | list %}
                {% set suggestions_state = 'idle' %}
                {% if suggestions.suggestions %}
                    {% if suggestion_stale|length == suggestions.suggestions|length %}
                        {% set suggestions_state = 'danger' %}
                    {% elif suggestion_stale %}
                        {% set suggestions_state = 'warn' %}
                    {% else %}
                        {% set suggestions_state = 'ok' %}
                    {% endif %}
                {% endif %}
                <div class="section-title">
                    <h2><span class="color-chip {{ suggestions_state }}"></span>Agent Suggestions</h2>
                    <span class="muted">{{ suggestions.suggestions | length }} live</span>
                    <span class="preflight-result" data-preflight-panel="suggestions">â³</span>
                </div>
                <div class="filter-bar">
                    <input type="search" id="suggestion-filter-mint" placeholder="Filter mintâ¦" aria-label="Filter by mint" />
                    <select id="suggestion-filter-agent" aria-label="Filter by agent">
                        <option value="">All agents</option>
                    </select>
                    <select id="suggestion-filter-side" aria-label="Filter by side">
                        <option value="">Any side</option>
                        <option value="buy">Buy</option>
                        <option value="sell">Sell</option>
                    </select>
                    <label><input type="checkbox" id="suggestion-filter-mismatch" /> Hash mismatch only</label>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Agent</th>
                            <th>Mint</th>
                            <th>Side</th>
                            <th>Notional</th>
                            <th>Edge</th>
                            <th>Breakeven</th>
                            <th>Edge Buffer</th>
                            <th>Gate</th>
                            <th>TTL</th>
                            <th>Age</th>
                            <th>Inputs Hash</th>
                            <th>Golden Hash</th>
                            <th>Integrity</th>
                            <th>Must</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in suggestions.suggestions %}
                        <tr class="{{ 'stale' if entry.stale else '' }}" data-agent="{{ entry.agent or '' }}" data-side="{{ entry.side or '' }}" data-mint="{{ entry.mint }}" data-mismatch="{{ '1' if entry.hash_mismatch else '0' }}">
                            <td>{{ entry.agent or 'â' }}</td>
                            <td><a href="#market-panel" class="mint-chip" data-mint="{{ entry.mint }}">{{ entry.mint }}</a></td>
                            <td>{{ entry.side or 'â' }}</td>
                            <td>{{ entry.notional_usd | round(2) if entry.notional_usd is not none else 'â' }}</td>
                            <td>{{ entry.edge | round(4) if entry.edge is not none else 'â' }}</td>
                            <td>{{ entry.breakeven_bps | round(2) if entry.breakeven_bps is not none else 'â' }} bps</td>
                            <td>{{ entry.edge_buffer_bps | round(2) if entry.edge_buffer_bps is not none else 'â' }} bps</td>
                            <td>
                                {% if entry.edge_pass is none %}
                                    <span class="pill neutral">Unknown</span>
                                {% elif entry.edge_pass %}
                                    <span class="pill pass">Pass</span>
                                {% else %}
                                    <span class="pill blocked">Blocked</span>
                                {% endif %}
                            </td>
                            <td>{{ entry.ttl_label }}</td>
                            <td>{{ entry.age_label }}</td>
                            <td class="muted">{{ entry.inputs_hash_short or 'â' }}</td>
                            <td class="muted">{{ entry.golden_hash_short or 'â' }}</td>
                            <td>
                                {% if entry.hash_mismatch %}
                                    <span class="pill stale">Mismatch</span>
                                {% else %}
                                    <span class="pill fresh">Aligned</span>
                                {% endif %}
                            </td>
                            <td>{{ 'yes' if entry.must else 'no' }}</td>
                        </tr>
                        {% else %}
                        <tr class="skeleton-row"><td colspan="14" class="muted">No active suggestions.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>

            </article>

            <article class="panel" id="vote-panel">
                {% set vote_state = 'idle' %}
                {% if vote_windows.windows %}
                    {% if vote_windows.windows | selectattr('expired') | list %}
                        {% set vote_state = 'warn' %}
                    {% else %}
                        {% set vote_state = 'ok' %}
                    {% endif %}
                {% endif %}
                <div class="section-title">
                    <h2><span class="color-chip {{ vote_state }}"></span>Vote Window Visualiser</h2>
                    <span class="muted">{{ vote_windows.windows | length }} open</span>
                    <span class="preflight-result" data-preflight-panel="vote">â³</span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Mint</th>
                            <th>Side</th>
                            <th>Quorum</th>
                            <th>Score</th>
                            <th>Countdown</th>
                            <th>Idempotency</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for window in vote_windows.windows %}
                        <tr class="{{ 'stale' if window.expired else '' }}">
                            <td>{{ window.mint }}</td>
                            <td>{{ window.side }}</td>
                            <td>{{ window.quorum }}</td>
                            <td>{{ window.score | round(3) if window.score is not none else 'â' }}</td>
                            <td>{{ window.countdown_label }}</td>
                            <td><span class="pill {{ 'fresh' if window.idempotent else 'stale' }}">{{ window.idempotency_label }}</span></td>
                        </tr>
                        {% else %}
                        <tr class="skeleton-row"><td colspan="6" class="muted">No open vote windows.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="decision-tape">
                    {% for decision in vote_windows.decisions %}
                    <div class="decision-card {{ 'duplicate' if decision.duplicate else '' }}">
                        <span class="badge {{ 'danger' if not decision.idempotent else 'ok' }}">{{ decision.idempotency_label }}</span>
                        <strong>{{ decision.mint }} Â· {{ decision.side }}</strong>
                        <div class="muted">clientOrderId {{ decision.client_order_id }}</div>
                        <div>Score {{ decision.score | round(3) if decision.score is not none else 'â' }} Â· Notional {{ decision.notional_usd or 'â' }}</div>
                        <div class="muted">{{ decision.age_label }} Â· First seen {{ decision.first_seen_label or 'n/a' }}</div>
                    </div>
                    {% else %}
                    <div class="muted">No decisions in tape.</div>
                    {% endfor %}
                </div>
            </article>
        </section>

        <section class="grid-two">
            <article class="panel" id="shadow-panel">
                {% set shadow_state = 'idle' %}
                {% if shadow.virtual_fills %}
                    {% if shadow.virtual_fills | selectattr('stale') | list %}
                        {% set shadow_state = 'warn' %}
                    {% else %}
                        {% set shadow_state = 'ok' %}
                    {% endif %}
                {% endif %}
                <div class="section-title">
                    <h2><span class="color-chip {{ shadow_state }}"></span>Shadow Execution</h2>
                    <span class="muted">{{ shadow.virtual_fills | length }} fills</span>
                    <span class="preflight-result" data-preflight-panel="shadow">â³</span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Mint</th>
                            <th>Side</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Slippage</th>
                            <th>Snapshot</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fill in shadow.virtual_fills %}
                        <tr class="{{ 'stale' if fill.stale else '' }}">
                            <td>{{ fill.mint }}</td>
                            <td>{{ fill.side }}</td>
                            <td>{{ fill.qty_base or 'â' }}</td>
                            <td>{{ fill.price_usd or 'â' }}</td>
                            <td>{{ fill.slippage_bps or 'â' }}</td>
                            <td><span class="muted">{{ fill.snapshot_hash_short }}</span> {% if fill.hash_mismatch %}<span class="pill stale">hash</span>{% endif %}</td>
                            <td>{{ fill.age_label }}</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="7" class="muted">Waiting for virtual fillsâ¦</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
                <h3>Paper Positions</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Mint</th>
                            <th>Side</th>
                            <th>Qty</th>
                            <th>Avg Cost</th>
                            <th>Unrealized</th>
                            <th>Total PnL</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pos in shadow.paper_positions %}
                        <tr>
                            <td>{{ pos.mint }}</td>
                            <td>{{ pos.side }}</td>
                            <td>{{ pos.qty_base }}</td>
                            <td>{{ pos.avg_cost }}</td>
                            <td>{{ pos.unrealized_usd }}</td>
                            <td>{{ pos.total_pnl_usd }}</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="6" class="muted">No paper positions.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </article>

            <article class="panel" id="rl-panel">
                {% set rl_state = 'idle' %}
                {% if rl_panel.weights %}
                    {% if rl_panel.weights | selectattr('stale') | list %}
                        {% set rl_state = 'warn' %}
                    {% else %}
                        {% set rl_state = 'ok' %}
                    {% endif %}
                {% endif %}
                <div class="section-title">
                    <h2><span class="color-chip {{ rl_state }}"></span>RL Weights & Uplift</h2>
                    <span class="muted">{{ rl_summary.weights_applied }} windows</span>
                    <span class="preflight-result" data-preflight-panel="rl">â³</span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Mint</th>
                            <th>Window Hash</th>
                            <th>Multiplier</th>
                            <th>Age</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in rl_panel.weights %}
                        <tr class="{{ 'stale' if entry.stale else '' }}">
                            <td>{{ entry.mint }}</td>
                            <td class="muted">{{ entry.window_hash_short }}</td>
                            <td>{{ entry.multiplier }}</td>
                            <td>{{ entry.age_label }}</td>
                        </tr>
                        {% else %}
                        <tr class="skeleton-row"><td colspan="4" class="muted">RL stream idle.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="metrics">
                    <div class="metric">
                        <span class="muted">Paper Uplift (5m)</span>
                        <strong>{{ rl_panel.uplift.get('rolling_5m', 0) | round(4) }}</strong>
                    </div>
                    <div class="metric">
                        <span class="muted">Last Decision Delta</span>
                        <strong>{{ rl_panel.uplift.get('last_decision_delta', 0) | round(4) }}</strong>
                    </div>
                    <div class="metric">
                        <span class="muted">Score Plain</span>
                        <strong>{{ rl_panel.uplift.get('score_plain', 0) | round(4) }}</strong>
                    </div>
                    <div class="metric">
                        <span class="muted">Score RL</span>
                        <strong>{{ rl_panel.uplift.get('score_rl', 0) | round(4) }}</strong>
                    </div>
                    <div class="metric">
                        <span class="muted">Uplift % (5m)</span>
                        <strong>{{ rl_panel.uplift.get('uplift_pct', 0) | round(2) }}%</strong>
                    </div>
                </div>
            </article>
        </section>

        <article class="panel" id="diagnostics-panel">
            <div class="section-title">
                {% set diag_state = 'idle' %}
                {% if exit_panel.queue %}
                    {% set diag_state = 'warn' %}
                {% elif exit_panel.hot_watch %}
                    {% set diag_state = 'ok' %}
                {% endif %}
                <h2><span class="color-chip {{ diag_state }}"></span>Exit Diagnostics</h2>
                <span class="muted">Queue {{ exit_panel.queue | length }} Â· Hot watch {{ exit_panel.hot_watch | length }}</span>
            </div>
            <div class="exit-hot-watch">
                <h3>Hot Watch</h3>
                {% if exit_panel.hot_watch %}
                <table class="compact">
                    <thead>
                        <tr>
                            <th>Mint</th>
                            <th>Reason</th>
                            <th>Breakeven</th>
                            <th>Trail</th>
                            <th>Time Left</th>
                            <th>Progress</th>
                            <th>Remaining</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for watch in exit_panel.hot_watch %}
                        <tr>
                            <td>{{ watch.token }}</td>
                            <td>{{ watch.reason }}</td>
                            <td>{{ watch.breakeven_bps | round(2) if watch.breakeven_bps is not none else 'â' }} bps</td>
                            <td>{{ watch.trail_status }}</td>
                            <td>{{ watch.window_remaining | round(1) if watch.window_remaining is not none else 'â' }}s</td>
                            <td>{{ (watch.progress * 100) | round(1) if watch.progress is not none else 'â' }}%</td>
                            <td>{{ watch.remaining | round(4) if watch.remaining is not none else 'â' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="muted">No tokens flagged for exit.</div>
                {% endif %}
                <h3>Exit Queue</h3>
                {% if exit_panel.queue %}
                <table class="compact">
                    <thead>
                        <tr>
                            <th>Mint</th>
                            <th>Reason</th>
                            <th>Must</th>
                            <th>Notional</th>
                            <th>Progress</th>
                            <th>Slices</th>
                            <th>Post-fill Qty</th>
                            <th>Age (s)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in exit_panel.queue %}
                        <tr>
                            <td>{{ item.token }}</td>
                            <td>{{ item.reason }}</td>
                            <td>{{ 'yes' if item.must else 'no' }}</td>
                            <td>{{ item.notional_usd | round(2) if item.notional_usd is not none else 'â' }}</td>
                            <td>
                                {% if item.progress is not none %}
                                    {{ (item.progress * 100) | round(1) }}%
                                    <span class="muted">({{ item.filled_qty | round(4) }}/{{ item.initial_qty | round(4) }})</span>
                                {% else %}
                                    â
                                {% endif %}
                            </td>
                            <td>
                                {% if item.slice_reasons %}
                                    {{ item.slice_reasons | join(', ') }}
                                {% else %}
                                    â
                                {% endif %}
                            </td>
                            <td>{{ item.post_fill_qty_preview | round(4) if item.post_fill_qty_preview is not none else 'â' }}</td>
                            <td>{{ item.age_sec | round(1) if item.age_sec is not none else 'â' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="muted">Exit queue empty.</div>
                {% endif %}
                <h3>Exit Diagnostics</h3>
                {% if exit_panel.diagnostics %}
                <div class="exit-diagnostics-grid">
                    {% for diag in exit_panel.diagnostics[:5] %}
                    <div class="exit-diagnostic-card">
                        <header>
                            <strong>{{ diag.token }}</strong>
                            <span class="muted">{% if diag.diagnostics.reason is defined and diag.diagnostics.reason %}{{ diag.diagnostics.reason }}{% elif diag.diagnostics is mapping and diag.diagnostics.get('reason') %}{{ diag.diagnostics.get('reason') }}{% else %}â{% endif %}</span>
                        </header>
                        <div class="micro-chart">
                            {% set samples = diag.monitor %}
                            {% if samples and samples|length > 1 %}
                            {% set recent = samples[-12:] %}
                            {% set entry_line = 0.0 %}
                            {% set trail_line = diag.diagnostics.trail_line_bps if diag.diagnostics is mapping and diag.diagnostics.get('trail_line_bps') is not none else None %}
                            {% set base_vals = [] %}
                            {% for sample in recent %}
                                {% set base_vals = base_vals + [sample.delta_mid_bps or 0.0] %}
                            {% endfor %}
                            {% set all_vals = base_vals + [entry_line] %}
                            {% if trail_line is not none %}
                                {% set all_vals = all_vals + [trail_line] %}
                            {% endif %}
                            {% if all_vals %}
                            {% set ns = namespace(init=False, min=0.0, max=0.0) %}
                            {% for val in all_vals %}
                                {% if not ns.init %}
                                    {% set ns.min = val %}
                                    {% set ns.max = val %}
                                    {% set ns.init = True %}
                                {% else %}
                                    {% if val < ns.min %}{% set ns.min = val %}{% endif %}
                                    {% if val > ns.max %}{% set ns.max = val %}{% endif %}
                                {% endif %}
                            {% endfor %}
                            {% if ns.max == ns.min %}
                                {% set ns.max = ns.min + 1 %}
                            {% endif %}
                            {% set denom = (ns.max - ns.min) if ns.max != ns.min else 1.0 %}
                            {% set ns_points = namespace(points=[]) %}
                            {% for sample in recent %}
                                {% set val = sample.delta_mid_bps or 0.0 %}
                                {% set normalized = (val - ns.min) / denom %}
                                {% set x = (loop.index0 / (recent|length - 1)) * 180 %}
                                {% set y = 50 - (normalized * 40) %}
                                {% set ns_points.points = ns_points.points + [x|string + ',' + y|string] %}
                            {% endfor %}
                            <svg viewBox="0 0 180 60" class="sparkline" preserveAspectRatio="none">
                                <polyline points="{{ ns_points.points|join(' ') }}" fill="none" stroke="#4f8cff" stroke-width="2" />
                                {% set entry_y = 50 - (((entry_line - ns.min) / denom) * 40) %}
                                <line x1="0" y1="{{ entry_y }}" x2="180" y2="{{ entry_y }}" stroke="#999" stroke-dasharray="4 4" />
                                {% if trail_line is not none %}
                                {% set trail_y = 50 - (((trail_line - ns.min) / denom) * 40) %}
                                <line x1="0" y1="{{ trail_y }}" x2="180" y2="{{ trail_y }}" stroke="#ff6b6b" stroke-dasharray="2 2" />
                                {% endif %}
                            </svg>
                            {% else %}
                            <div class="muted">No micro-samples yet.</div>
                            {% endif %}
                            {% else %}
                            <div class="muted">No micro-samples yet.</div>
                            {% endif %}
                            <button class="flatten-btn" data-mint="{{ diag.token }}">Flatten</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="muted">No exit diagnostics yet.</div>
                {% endif %}
                <h3>Missed Exits</h3>
                {% if exit_panel.missed_exits %}
                <ul class="missed-exits">
                    {% for miss in exit_panel.missed_exits[:10] %}
                    <li><strong>{{ miss.token }}</strong> Â· {{ miss.reason }} Â· <span class="muted">{{ miss.ts }}</span></li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="muted">No missed exits recorded.</div>
                {% endif %}
                <h3>Recently Closed</h3>
                {% if exit_panel.closed %}
                <ul>
                    {% for diag in exit_panel.closed[:5] %}
                    {% set total_pnl = diag.slices | sum(attribute='pnl') %}
                    <li><strong>{{ diag.token }}</strong> Â· {{ total_pnl | round(4) }} Â· {% if diag.diagnostics.reason is defined and diag.diagnostics.reason %}{{ diag.diagnostics.reason }}{% elif diag.diagnostics is mapping and diag.diagnostics.get('reason') %}{{ diag.diagnostics.get('reason') }}{% else %}â{% endif %}</li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="muted">No closed exits recorded.</div>
                {% endif %}
            </div>
        </article>

        <section class="panel" id="settings-panel">
            <div class="section-title">
                <h2><span class="color-chip idle"></span>Settings & Controls</h2>
                <span class="muted">{{ settings.controls | length }} controls</span>
            </div>
            <div class="control-grid">
                {% for control in settings.controls %}
                <div class="control-card">
                    <strong>{{ control.label }}</strong>
                    <div class="muted">Endpoint {{ control.endpoint }}</div>
                    <div>Status: {{ control.state }}</div>
                    <div>TTL: {{ control.ttl_label }}</div>
                </div>
                {% else %}
                <div class="muted">No controls available.</div>
                {% endfor %}
            </div>
        </section>

        </div>
    </div>
    <footer class="status-strip">
        <div id="status-strip-message">Awaiting handshakeâ¦</div>
        <div id="status-strip-schema">Schema â</div>
        <div id="status-strip-clock">--:--:--</div>
    </footer>

    <script>
            (function () {
                const bodyEl = document.body;
                const connectionBanner = document.getElementById('connection-banner');
                const connectionLabel = document.getElementById('connection-status-label');
                const connectionDetail = document.getElementById('connection-status-detail');
                const schemaBanner = document.getElementById('schema-banner');
                const schemaBannerTitle = document.getElementById('schema-banner-title');
                const schemaBannerDetail = document.getElementById('schema-banner-detail');
                const handshakeStatus = document.getElementById('handshake-status');
                const handshakeBroker = document.getElementById('handshake-broker');
                const handshakeChannel = document.getElementById('handshake-channel');
                const handshakeRuntime = document.getElementById('handshake-runtime');
                const handshakeSpinner = document.getElementById('handshake-spinner');
                const connectivityPill = document.getElementById('connectivity-pill');
                const lagTopBus = document.getElementById('lag-bus-top');
                const lagTopDepth = document.getElementById('lag-depth-top');
                const lagTopGolden = document.getElementById('lag-golden-top');
                const statusStripMessage = document.getElementById('status-strip-message');
                const statusStripSchema = document.getElementById('status-strip-schema');
                const statusStripClock = document.getElementById('status-strip-clock');
                const environmentPill = document.getElementById('environment-pill');
                const paperPill = document.getElementById('paper-pill');
                const rlPill = document.getElementById('rl-pill');
                const selfCheckPill = document.getElementById('self-check-pill');
                const goldenDemoButton = document.getElementById('golden-demo-button');
                const navLinks = Array.from(document.querySelectorAll('.nav-link[data-target]'));
                const UI_SCHEMA_VERSION = 3;
                let latestMeta = null;
                let schemaCompatible = true;
                let handshakeComplete = false;
                const pendingEventFrames = [];
                const channelOrder = ['events', 'market', 'golden', 'agents', 'rl', 'logs'];
                const websocketChannels = ['events', 'rl', 'logs'];
                const channelLabels = {
                    events: 'Events',
                    market: 'Market',
                    golden: 'Golden',
                    agents: 'Agents',
                    rl: 'RL',
                    logs: 'Logs'
                };
                const navTargets = {
                    overview: document.getElementById('overview'),
                    discovery: document.getElementById('discovery'),
                    market: document.getElementById('market-panel'),
                    golden: document.getElementById('golden-panel'),
                    agents: document.getElementById('suggestions-panel'),
                    execution: document.getElementById('vote-panel'),
                    diagnostics: document.getElementById('diagnostics-panel'),
                    settings: document.getElementById('settings-panel')
                };
                const preflightIndicators = new Map();
                document.querySelectorAll('.preflight-result[data-preflight-panel]').forEach((node) => {
                    if (!node || !node.dataset) {
                        return;
                    }
                    const panelKey = (node.dataset.preflightPanel || '').trim();
                    if (!panelKey) {
                        return;
                    }
                    if (!node.textContent || !node.textContent.trim()) {
                        node.textContent = 'â³';
                    }
                    node.dataset.preflightState = node.dataset.preflightState || 'pending';
                    node.setAttribute('role', 'status');
                    preflightIndicators.set(panelKey, node);
                });
                const runLiveState = new Map();
                let lastStatusMessage = '';

                function setHandshakeSpinnerActive(active) {
                    if (!handshakeSpinner) {
                        return;
                    }
                    if (active) {
                        handshakeSpinner.classList.add('active');
                    } else {
                        handshakeSpinner.classList.remove('active');
                    }
                }

                function formatLagLabel(value) {
                    if (typeof value !== 'number' || !Number.isFinite(value)) {
                        return 'â';
                    }
                    return Math.round(value) + ' ms';
                }

                function updateTopLags(bus, depth, golden) {
                    if (lagTopBus) {
                        lagTopBus.textContent = formatLagLabel(bus);
                    }
                    if (lagTopDepth) {
                        lagTopDepth.textContent = formatLagLabel(depth);
                    }
                    if (lagTopGolden) {
                        lagTopGolden.textContent = formatLagLabel(golden);
                    }
                }

                function titleCase(value) {
                    if (!value && value !== 0) {
                        return '';
                    }
                    return String(value)
                        .replace(/[_-]+/g, ' ')
                        .split(' ')
                        .filter(Boolean)
                        .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
                        .join(' ');
                }

                function updateSelfCheckPill(snapshot) {
                    if (!selfCheckPill) {
                        return;
                    }
                    const info = snapshot && typeof snapshot === 'object' ? snapshot : {};
                    const raw = info.status || info.state || (info.ok ? 'ok' : '');
                    const statusValue = typeof raw === 'string' ? raw.toLowerCase() : String(raw || '').toLowerCase();
                    let statusKey = 'pending';
                    if (statusValue === 'ok' || statusValue === 'pass' || statusValue === 'passed') {
                        statusKey = 'ok';
                    } else if (statusValue === 'partial') {
                        statusKey = 'partial';
                    } else if (statusValue === 'degraded') {
                        statusKey = 'degraded';
                    } else if (statusValue === 'failed' || statusValue === 'fail' || statusValue === 'error') {
                        statusKey = 'failed';
                    } else if (statusValue === 'running') {
                        statusKey = 'running';
                    } else if (statusValue === 'pending') {
                        statusKey = 'pending';
                    }
                    const classNames = ['status-ok', 'status-partial', 'status-degraded', 'status-failed', 'status-running', 'status-pending'];
                    classNames.forEach((cls) => selfCheckPill.classList.remove(cls));
                    selfCheckPill.classList.add('status-' + statusKey);
                    selfCheckPill.dataset.status = statusKey;
                    const labelMap = {
                        ok: 'OK',
                        partial: 'PARTIAL',
                        degraded: 'DEGRADED',
                        failed: 'FAILED',
                        running: 'RUNNING',
                        pending: 'PENDING'
                    };
                    const label = labelMap[statusKey] || 'PENDING';
                    selfCheckPill.textContent = 'Self-check: ' + label;
                    if (info.detail) {
                        selfCheckPill.title = String(info.detail);
                    } else if (info.checks && typeof info.checks === 'object') {
                        try {
                            selfCheckPill.title = 'Checks: ' + Object.keys(info.checks).join(', ');
                        } catch (err) {
                            selfCheckPill.title = 'Self-check status: ' + label;
                        }
                    } else {
                        selfCheckPill.removeAttribute('title');
                    }
                }

                function updatePreflightIndicator(name, status, detail) {
                    const indicator = preflightIndicators.get(name);
                    if (!indicator) {
                        return;
                    }
                    const symbolMap = {
                        ok: 'â',
                        warn: 'â ï¸',
                        error: 'â',
                        pending: 'â³'
                    };
                    const symbol = symbolMap[status] || symbolMap.pending;
                    indicator.dataset.preflightState = status;
                    indicator.textContent = symbol;
                    const descriptor = indicator.dataset.preflightPanel || name;
                    if (detail) {
                        indicator.title = detail;
                    } else {
                        indicator.removeAttribute('title');
                    }
                    const label = [descriptor, String(status || 'pending').toUpperCase()]
                        .filter(Boolean)
                        .join(' ');
                    const ariaDetail = detail ? label + ' Â· ' + detail : label;
                    indicator.setAttribute('aria-label', ariaDetail);
                }

                function scheduleRunLivePoll(name, endpoint, delayMs) {
                    let state = runLiveState.get(name);
                    if (!state) {
                        state = {timer: null, retries: 0, endpoint: endpoint};
                        runLiveState.set(name, state);
                    }
                    state.endpoint = endpoint;
                    if (state.timer) {
                        window.clearTimeout(state.timer);
                    }
                    state.timer = window.setTimeout(() => {
                        state.timer = null;
                        probeRunLivePanel(name, endpoint);
                    }, delayMs);
                }

                async function probeRunLivePanel(name, endpoint) {
                    const indicator = preflightIndicators.get(name);
                    const state = runLiveState.get(name) || {retries: 0, endpoint: endpoint};
                    runLiveState.set(name, state);
                    if (indicator) {
                        indicator.dataset.preflightEndpoint = endpoint;
                    }
                    updatePreflightIndicator(name, 'pending', 'Connectingâ¦');
                    try {
                        const response = await fetch(endpoint, {cache: 'no-store'});
                        if (!response.ok) {
                            throw new Error('HTTP ' + response.status);
                        }
                        const payload = await response.json().catch(() => null);
                        if (payload && typeof payload === 'object' && payload.ok === false) {
                            const detail = payload.error ? String(payload.error) : 'Endpoint reported failure';
                            throw new Error(detail);
                        }
                        state.retries = 0;
                        updatePreflightIndicator(name, 'ok', 'Connected to ' + endpoint);
                        scheduleRunLivePoll(name, endpoint, 15000);
                    } catch (err) {
                        const message = err && err.message ? err.message : 'Request failed';
                        state.retries = (state.retries || 0) + 1;
                        updatePreflightIndicator(name, 'error', message);
                        const retryDelay = Math.min(60000, 2000 * state.retries);
                        scheduleRunLivePoll(name, endpoint, retryDelay);
                    }
                }

                function initRunLiveConnectivity() {
                    if (!preflightIndicators.size) {
                        return;
                    }
                    const startProbes = (mapping) => {
                        preflightIndicators.forEach((_node, panelName) => {
                            const variants = [panelName, panelName.replace(/_/g, '-'), panelName.replace(/-/g, '_')];
                            let endpoint = '';
                            for (const variant of variants) {
                                if (mapping && Object.prototype.hasOwnProperty.call(mapping, variant)) {
                                    endpoint = String(mapping[variant] || '').trim();
                                    if (endpoint) {
                                        break;
                                    }
                                }
                            }
                            if (!endpoint) {
                                endpoint = '/run/live/' + panelName;
                            }
                            probeRunLivePanel(panelName, endpoint);
                        });
                    };
                    const fallback = () => startProbes({});
                    fetch('/run/live', {cache: 'no-store'})
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error('HTTP ' + response.status);
                            }
                            return response.json();
                        })
                        .then((manifest) => {
                            if (!manifest || typeof manifest !== 'object') {
                                fallback();
                                return;
                            }
                            let panels = manifest.panels || manifest.endpoints || manifest.data;
                            if (!panels) {
                                fallback();
                                return;
                            }
                            const mapping = {};
                            if (Array.isArray(panels)) {
                                panels.forEach((entry) => {
                                    if (!entry || typeof entry !== 'object') {
                                        return;
                                    }
                                    const name = entry.name || entry.panel || entry.key;
                                    const endpoint = entry.endpoint || entry.url;
                                    if (!name || !endpoint) {
                                        return;
                                    }
                                    mapping[String(name).trim()] = String(endpoint).trim();
                                });
                            } else {
                                Object.keys(panels).forEach((key) => {
                                    const value = panels[key];
                                    if (typeof value === 'string') {
                                        mapping[String(key).trim()] = value.trim();
                                    } else if (value && typeof value === 'object') {
                                        const endpoint = value.endpoint || value.url;
                                        if (endpoint) {
                                            mapping[String(key).trim()] = String(endpoint).trim();
                                        }
                                    }
                                });
                            }
                            startProbes(mapping);
                        })
                        .catch(() => {
                            fallback();
                        });
                }

                function updateStatusPills(meta) {
                    if (!meta || typeof meta !== 'object') {
                        updateSelfCheckPill(null);
                        return;
                    }
                    if (environmentPill) {
                        const envRaw = meta.environment || '';
                        const envValue = envRaw ? String(envRaw).toUpperCase() : 'UNKNOWN';
                        environmentPill.textContent = 'ð Env ' + envValue;
                        environmentPill.className = 'signal-pill env-pill env-' + envValue.toLowerCase();
                        const workflow = meta.version && meta.version.workflow ? String(meta.version.workflow) : '';
                        if (workflow) {
                            environmentPill.title = workflow;
                        } else {
                            environmentPill.removeAttribute('title');
                        }
                    }
                    const executionMeta = meta.execution || {};
                    if (paperPill) {
                        const paperOn = Boolean(executionMeta.paper);
                        paperPill.classList.remove('toggle-on', 'toggle-off', 'toggle-paused');
                        paperPill.classList.add(paperOn ? 'toggle-on' : 'toggle-off');
                        paperPill.textContent = 'ð Paper ' + (paperOn ? 'ON' : 'OFF');
                        const keypairMode = executionMeta.keypair_mode ? String(executionMeta.keypair_mode) : '';
                        if (keypairMode) {
                            paperPill.title = 'Keypair: ' + titleCase(keypairMode);
                        } else {
                            paperPill.removeAttribute('title');
                        }
                    }
                    if (rlPill) {
                        const featuresMeta = meta.features || {};
                        const rlModeRaw = executionMeta.rl_mode || (featuresMeta.rl_shadow_enabled ? 'shadow' : 'applied');
                        const rlMode = rlModeRaw ? String(rlModeRaw) : 'shadow';
                        let rlText = titleCase(rlMode) || 'Shadow';
                        const rlGateRaw = executionMeta.rl_gate ? String(executionMeta.rl_gate) : '';
                        const rlGate = rlGateRaw.toLowerCase();
                        const rlReason = executionMeta.rl_gate_reason ? String(executionMeta.rl_gate_reason) : '';
                        rlPill.classList.remove('toggle-on', 'toggle-off', 'toggle-paused');
                        if (rlGate && rlGate !== 'open') {
                            rlText += ' Â· ' + titleCase(rlGate);
                            rlPill.classList.add('toggle-paused');
                        } else if (rlMode.toLowerCase() === 'applied') {
                            rlPill.classList.add('toggle-on');
                        } else {
                            rlPill.classList.add('toggle-off');
                        }
                        rlPill.textContent = 'ð¤ RL ' + rlText;
                        if (rlReason) {
                            rlPill.title = titleCase(rlReason);
                        } else if (rlGate && rlGate !== 'open') {
                            rlPill.title = 'Gate ' + rlGate;
                        } else {
                            rlPill.removeAttribute('title');
                        }
                    }
                    updateSelfCheckPill(meta.self_check);
                }

                function setStatusMessage(message) {
                    if (!statusStripMessage || !message) {
                        return;
                    }
                    lastStatusMessage = message;
                    statusStripMessage.textContent = message;
                }

                function updateStatusClock() {
                    if (!statusStripClock) {
                        return;
                    }
                    const now = new Date();
                    statusStripClock.textContent = now.toLocaleTimeString(undefined, {hour: '2-digit', minute: '2-digit', second: '2-digit'});
                }

                function updateHandshakeDetails(meta) {
                    if (!meta || typeof meta !== 'object') {
                        return;
                    }
                    const broker = meta.broker || {};
                    if (handshakeBroker) {
                        handshakeBroker.textContent = broker.url || broker.host || 'â';
                    }
                    if (handshakeChannel) {
                        handshakeChannel.textContent = meta.channel || broker.channel || 'â';
                    }
                    if (handshakeRuntime) {
                        const version = meta.version || {};
                        const parts = [];
                        if (version.app_version) {
                            parts.push(version.app_version);
                        }
                        if (version.build_git) {
                            parts.push(version.build_git);
                        }
                        if (version.workflow) {
                            parts.push(version.workflow);
                        }
                        if (!parts.length && version.mode) {
                            parts.push(String(version.mode).toUpperCase());
                        }
                        handshakeRuntime.textContent = parts.join(' Â· ') || 'â';
                    }
                    if (statusStripSchema) {
                        const version = meta.version || {};
                        const schemaHash = version.schema_hash || 'â';
                        statusStripSchema.textContent = 'Schema ' + schemaHash;
                    }
                    if (handshakeStatus) {
                        if (!schemaCompatible) {
                            handshakeStatus.textContent = 'Negotiating schemaâ¦';
                        } else {
                            const versionNumber = typeof meta.v === 'number' ? meta.v : UI_SCHEMA_VERSION;
                            handshakeStatus.textContent = 'UI_META v' + versionNumber + ' negotiated';
                        }
                    }
                }

                function markHandshakeComplete() {
                    if (handshakeComplete) {
                        return;
                    }
                    handshakeComplete = true;
                    if (bodyEl) {
                        bodyEl.classList.remove('handshake-pending');
                        bodyEl.classList.add('handshake-complete');
                    }
                    setHandshakeSpinnerActive(false);
                }

                function highlightNav(targetKey) {
                    navLinks.forEach((link) => {
                        if (link.dataset.target === targetKey) {
                            link.classList.add('active');
                        } else {
                            link.classList.remove('active');
                        }
                    });
                }

                function initNavObserver() {
                    if (!('IntersectionObserver' in window)) {
                        return;
                    }
                    const observer = new IntersectionObserver((entries) => {
                        let best = null;
                        for (const entry of entries) {
                            if (!entry.isIntersecting) {
                                continue;
                            }
                            if (!best || entry.intersectionRatio > best.intersectionRatio) {
                                best = entry;
                            }
                        }
                        if (best) {
                            const key = Object.keys(navTargets).find((navKey) => navTargets[navKey] === best.target);
                            if (key) {
                                highlightNav(key);
                            }
                        }
                    }, {threshold: [0.3, 0.6]});
                    Object.keys(navTargets).forEach((key) => {
                        const element = navTargets[key];
                        if (element) {
                            observer.observe(element);
                        }
                    });
                }

                function createChannel(initialDetail) {
                    return {
                        status: 'connecting',
                        detail: initialDetail,
                        socket: null,
                        retryTimer: null,
                        retries: 0,
                        url: ''
                    };
                }

                const channelState = {
                    events: createChannel('Waiting for metadataâ¦'),
                    market: createChannel('Awaiting market data'),
                    golden: createChannel('Awaiting golden stream'),
                    agents: createChannel('Awaiting agent data'),
                    rl: createChannel('Waiting for metadataâ¦'),
                    logs: createChannel('Waiting for metadataâ¦')
                };

                function updateSchemaBanner(meta) {
                    if (!schemaBanner || !schemaBannerDetail) {
                        schemaCompatible = true;
                        return;
                    }
                    if (!meta || typeof meta !== 'object') {
                        schemaBanner.classList.remove('visible');
                        schemaBannerDetail.textContent = '';
                        if (schemaBannerTitle) {
                            schemaBannerTitle.textContent = 'Schema ready';
                        }
                        schemaCompatible = true;
                        return;
                    }
                    const rawVersion = meta.v;
                    const version = typeof rawVersion === 'number' ? rawVersion : Number(rawVersion);
                    if (Number.isFinite(version) && version !== UI_SCHEMA_VERSION) {
                        schemaBanner.classList.add('visible');
                        if (schemaBannerTitle) {
                            schemaBannerTitle.textContent = 'Negotiating schemaâ¦';
                        }
                        schemaBannerDetail.textContent = 'Expected v' + UI_SCHEMA_VERSION + ' Â· Received ' + version;
                        schemaCompatible = false;
                    } else {
                        schemaBanner.classList.remove('visible');
                        if (schemaBannerTitle) {
                            schemaBannerTitle.textContent = 'Schema ready';
                        }
                        schemaBannerDetail.textContent = '';
                        schemaCompatible = true;
                    }
                }

                function applyMeta(meta) {
                    latestMeta = meta && typeof meta === 'object' ? meta : null;
                    updateSchemaBanner(latestMeta);
                    if (!latestMeta) {
                        return;
                    }
                    updateHandshakeDetails(latestMeta);
                    updateStatusPills(latestMeta);
                    if (connectionBanner) {
                        const lag = latestMeta.lag || {};
                        const busLag = typeof lag.bus_ms === 'number' ? lag.bus_ms : null;
                        const ohlcvLag = typeof lag.ohlcv_ms === 'number' ? lag.ohlcv_ms : null;
                        const depthLag = typeof lag.depth_ms === 'number' ? lag.depth_ms : null;
                        const goldenLag = typeof lag.golden_ms === 'number' ? lag.golden_ms : null;
                        connectionBanner.dataset.busLag = busLag === null ? '' : String(busLag);
                        connectionBanner.dataset.ohlcvLag = ohlcvLag === null ? '' : String(ohlcvLag);
                        connectionBanner.dataset.depthLag = depthLag === null ? '' : String(depthLag);
                        connectionBanner.dataset.goldenLag = goldenLag === null ? '' : String(goldenLag);
                        updateTopLags(busLag, depthLag, goldenLag);
                    }
                    const detailParts = [];
                    if (latestMeta.channel) {
                        detailParts.push('Channel ' + latestMeta.channel);
                    }
                    const redisInfo = latestMeta.redis || {};
                    if (redisInfo && Object.prototype.hasOwnProperty.call(redisInfo, 'db')) {
                        detailParts.push('DB ' + redisInfo.db);
                    }
                    const detailText = schemaCompatible
                        ? (detailParts.join(' Â· ') || 'Streaming')
                        : 'Negotiating schemaâ¦';
                    const eventStatus = schemaCompatible ? 'open' : 'pending';
                    setChannelState('events', eventStatus, detailText);
                    updateDataChannelsFromBanner();
                    renderConnectionSummary();
                    markHandshakeComplete();
                    if (schemaCompatible) {
                        setStatusMessage('Connected to runtime');
                    } else {
                        setStatusMessage('Negotiating schemaâ¦');
                    }
                }

                function processPendingEventFrames() {
                    if (!schemaCompatible || !latestMeta) {
                        setHandshakeSpinnerActive(pendingEventFrames.length > 0);
                        return;
                    }
                    while (pendingEventFrames.length) {
                        const frame = pendingEventFrames.shift();
                        handleEventFrame(frame);
                    }
                    setHandshakeSpinnerActive(false);
                }

                function handleEventFrame(frame) {
                    if (!frame) {
                        return;
                    }
                    // Realtime event handling is populated by downstream modules.
                }

                function parseMessagePayload(data) {
                    if (typeof data === 'string') {
                        const trimmed = data.trim();
                        if (!trimmed) {
                            return null;
                        }
                        if (trimmed.startsWith('{') || trimmed.startsWith('[')) {
                            try {
                                return JSON.parse(trimmed);
                            } catch (err) {
                                console.error('ui-msg-error', err, {payload: data});
                                return {__raw__: data};
                            }
                        }
                        return trimmed;
                    }
                    if (data && typeof data === 'object' && (typeof Blob === 'undefined' || !(data instanceof Blob))) {
                        return data;
                    }
                    return null;
                }

                function normalizeStatus(status) {
                    switch (status) {
                        case 'open':
                        case 'ok':
                        case 'streaming':
                            return 'ok';
                        case 'warn':
                        case 'warning':
                            return 'warn';
                        case 'error':
                        case 'fail':
                        case 'danger':
                            return 'danger';
                        case 'connecting':
                        case 'pending':
                        case 'waiting':
                            return 'pending';
                        default:
                            return 'idle';
                    }
                }

                function statusClassFor(status) {
                    const normalized = normalizeStatus(status);
                    switch (normalized) {
                        case 'ok':
                            return 'status-ok';
                        case 'warn':
                            return 'status-warn';
                        case 'danger':
                            return 'status-danger';
                        case 'pending':
                            return 'status-pending';
                        default:
                            return 'status-idle';
                    }
                }

                function renderConnectionSummary() {
                    if (!connectionBanner || !connectionLabel || !connectionDetail) {
                        return;
                    }
                    let anyError = false;
                    let anyWarn = false;
                    let allNominal = true;
                    const parts = [];
                    const fragment = document.createDocumentFragment();
                    channelOrder.forEach((name) => {
                        const info = channelState[name];
                        if (!info) {
                            return;
                        }
                        const label = channelLabels[name] || name;
                        const normalized = normalizeStatus(info.status);
                        if (normalized === 'danger') {
                            anyError = true;
                        } else if (normalized === 'warn') {
                            anyWarn = true;
                        }
                        if (normalized !== 'ok') {
                            allNominal = false;
                        }
                        if (info.detail) {
                            parts.push(label + ': ' + info.detail);
                        } else {
                            parts.push(label);
                        }
                        const badge = document.createElement('span');
                        badge.className = 'connection-badge ' + statusClassFor(info.status);
                        badge.dataset.channel = name;
                        badge.dataset.status = info.status;
                        badge.title = info.detail ? label + ': ' + info.detail : label;
                        const labelSpan = document.createElement('span');
                        labelSpan.className = 'badge-label';
                        labelSpan.textContent = label;
                        badge.appendChild(labelSpan);
                        if (info.detail) {
                            const detailSpan = document.createElement('span');
                            detailSpan.className = 'badge-detail';
                            detailSpan.textContent = info.detail;
                            badge.appendChild(detailSpan);
                        }
                        fragment.appendChild(badge);
                    });
                    connectionDetail.replaceChildren(fragment);
                    connectionDetail.setAttribute('data-status-text', parts.join(' Â· '));
                    let overall = 'connecting';
                    if (anyError) {
                        overall = 'error';
                    } else if (anyWarn) {
                        overall = 'warning';
                    } else if (allNominal && parts.length) {
                        overall = 'ok';
                    }
                    const messages = {
                        ok: 'Realtime streams nominal',
                        error: 'Realtime stream disconnected',
                        warning: 'Realtime stream degraded',
                        connecting: 'Connecting to runtimeâ¦'
                    };
                    const statusKey = overall === 'ok' ? 'open' : overall;
                    connectionLabel.textContent = messages[overall] || messages.connecting;
                    connectionBanner.className = 'connection-banner connection-banner--' + overall;
                    if (connectivityPill) {
                        const pillMessages = {
                            open: 'Connected',
                            warning: 'Degraded',
                            error: 'Disconnected',
                            connecting: 'Connectingâ¦'
                        };
                        connectivityPill.className = 'connectivity-pill status-' + statusKey;
                        const pillLabelEl = connectivityPill.querySelector('.pill-label');
                        if (pillLabelEl) {
                            pillLabelEl.textContent = pillMessages[statusKey] || pillMessages.connecting;
                        }
                        connectivityPill.setAttribute('aria-label', messages[overall] || messages.connecting);
                    }
                    if (messages[overall]) {
                        setStatusMessage(messages[overall]);
                    }
                }

                function setChannelState(name, status, detail) {
                    const info = channelState[name];
                    if (!info) {
                        return;
                    }
                    info.status = status;
                    if (typeof detail === 'string' && detail) {
                        info.detail = detail;
                    }
                    if (status === 'open') {
                        info.retries = 0;
                    }
                    renderConnectionSummary();
                }

                function parseLag(value) {
                    if (typeof value !== 'string' || value === '') {
                        return null;
                    }
                    const parsed = Number(value);
                    return Number.isFinite(parsed) ? parsed : null;
                }

                function setLagChannel(name, lagValue, waitingDetail) {
                    const info = channelState[name];
                    if (!info) {
                        return;
                    }
                    if (lagValue === null) {
                        setChannelState(name, 'connecting', waitingDetail);
                        return;
                    }
                    let status = 'open';
                    if (lagValue > 1500) {
                        status = 'error';
                    } else if (lagValue > 600) {
                        status = 'warn';
                    }
                    const detail = 'Lag ' + Math.round(lagValue) + ' ms';
                    setChannelState(name, status, detail);
                }

                function updateDataChannelsFromBanner() {
                    if (!connectionBanner) {
                        return;
                    }
                    const busLag = parseLag(connectionBanner.dataset.busLag);
                    const ohlcvLag = parseLag(connectionBanner.dataset.ohlcvLag);
                    const depthLag = parseLag(connectionBanner.dataset.depthLag);
                    const goldenLag = parseLag(connectionBanner.dataset.goldenLag);
                    const agentStale = connectionBanner.dataset.agentsStale === '1';
                    const agentAge = connectionBanner.dataset.agentsAge || 'n/a';
                    updateTopLags(busLag, depthLag, goldenLag);
                    const lagValues = [];
                    if (ohlcvLag !== null) {
                        lagValues.push(ohlcvLag);
                    }
                    if (depthLag !== null) {
                        lagValues.push(depthLag);
                    }
                    const marketLag = lagValues.length ? Math.max(...lagValues) : null;
                    setLagChannel('market', marketLag, 'Awaiting market data');
                    setLagChannel('golden', goldenLag, 'Awaiting golden stream');
                    const agentPrefix = agentStale ? 'Stale' : 'Fresh';
                    const agentDetail = (agentPrefix + ' Â· ' + agentAge).trim();
                    setChannelState('agents', agentStale ? 'warn' : 'open', agentDetail);
                }

                function shortUrl(url) {
                    if (typeof url !== 'string') {
                        return '';
                    }
                    if (url.startsWith('wss://')) {
                        return url.slice(6);
                    }
                    if (url.startsWith('ws://')) {
                        return url.slice(5);
                    }
                    return url;
                }

                function scheduleReconnect(name, url, reasonText) {
                    const info = channelState[name];
                    if (!info) {
                        return;
                    }
                    if (info.retryTimer) {
                        return;
                    }
                    const attempt = info.retries || 0;
                    const delay = Math.min(10000, 1000 * Math.pow(2, attempt));
                    info.retryTimer = window.setTimeout(() => {
                        info.retryTimer = null;
                        setChannelState(name, 'connecting', 'Connectingâ¦');
                        connectChannel(name, url);
                    }, delay);
                    info.retries = attempt + 1;
                    const retryLabel = 'retrying in ' + Math.round(delay / 1000) + 's';
                    const prefix = reasonText ? reasonText + ' â ' : '';
                    const suffix = url ? ' (' + shortUrl(url) + ')' : '';
                    setChannelState(name, 'error', prefix + retryLabel + suffix);
                }

                function connectChannel(name, url) {
                    const info = channelState[name];
                    if (!info) {
                        return;
                    }
                    if (info.retryTimer) {
                        window.clearTimeout(info.retryTimer);
                        info.retryTimer = null;
                    }
                    if (info.socket) {
                        try {
                            info.socket.close(1000, 'reconnecting');
                        } catch (err) {
                            // ignore
                        }
                        info.socket = null;
                    }
                    if (!window.WebSocket) {
                        setChannelState(name, 'error', 'WebSocket unsupported');
                        return;
                    }
                    if (!url) {
                        setChannelState(name, 'warn', 'No endpoint provided');
                        return;
                    }
                    info.url = url;
                    setChannelState(name, 'connecting', 'Connectingâ¦');
                    let socket;
                    try {
                        socket = new WebSocket(url);
                    } catch (err) {
                        const message = err && err.message ? err.message : 'failed to open socket';
                        setChannelState(name, 'error', 'Failed to open â ' + message);
                        scheduleReconnect(name, url, 'connect error');
                        return;
                    }
                    info.socket = socket;
                    socket.addEventListener('open', () => {
                        setChannelState(name, 'open', 'Connected');
                        try {
                            const helloFrame = JSON.stringify({event: 'hello', client: 'solhunter-ui', version: UI_SCHEMA_VERSION});
                            socket.send(helloFrame);
                        } catch (err) {
                            // ignore handshake send errors
                        }
                    });
                    socket.addEventListener('message', (event) => {
                        if (!event || typeof event.data === 'undefined') {
                            return;
                        }
                        const payload = parseMessagePayload(event.data);
                        if (payload && typeof payload === 'object' && Object.prototype.hasOwnProperty.call(payload, '__raw__')) {
                            setChannelState(name, 'warn', 'Bad frame skipped');
                            return;
                        }
                        if (payload && typeof payload === 'object' && !Array.isArray(payload)) {
                            const frameType = String(payload.type || payload.event || '').toLowerCase();
                            if (frameType === 'hello') {
                                return;
                            }
                            if (frameType === 'ui_meta' && name === 'events') {
                                applyMeta(payload);
                                processPendingEventFrames();
                                return;
                            }
                        }
                        if (name === 'events') {
                            if (!latestMeta || !schemaCompatible) {
                                pendingEventFrames.push(payload);
                                if (pendingEventFrames.length > 500) {
                                    pendingEventFrames.shift();
                                }
                                setHandshakeSpinnerActive(true);
                                return;
                            }
                            handleEventFrame(payload);
                        }
                        if (info.status !== 'open' || info.detail === 'Connected') {
                            const detail = schemaCompatible ? 'Streaming' : (info.detail || 'Streaming');
                            setChannelState(name, 'open', detail);
                        }
                    });
                    socket.addEventListener('close', (event) => {
                        const code = event && typeof event.code === 'number' ? event.code : 1000;
                        const reason = event && event.reason ? event.reason : '';
                        info.socket = null;
                        if (name === 'events') {
                            latestMeta = null;
                            updateSchemaBanner(null);
                            pendingEventFrames.length = 0;
                        }
                        const reasonText = 'closed (' + code + (reason ? ' ' + reason : '') + ')';
                        scheduleReconnect(name, url, reasonText);
                    });
                    socket.addEventListener('error', (event) => {
                        const detail = event && event.message ? event.message : 'socket error';
                        const suffix = info.url ? ' (' + shortUrl(info.url) + ')' : '';
                        setChannelState(name, 'error', 'Error â ' + detail + suffix);
                    });
                }

                async function bootRealtime() {
                    renderConnectionSummary();
                    let meta;
                    try {
                        const response = await fetch('/ui/meta', {cache: 'no-store'});
                        if (!response.ok) {
                            throw new Error('HTTP ' + response.status);
                        }
                        meta = await response.json();
                        if (meta && typeof meta.meta === 'object') {
                            applyMeta(meta.meta);
                            processPendingEventFrames();
                        }
                    } catch (err) {
                        const message = err && err.message ? err.message : 'failed to load meta';
                        websocketChannels.forEach((name) => {
                            setChannelState(name, 'error', 'Meta fetch failed â ' + message);
                        });
                        if (handshakeStatus) {
                            handshakeStatus.textContent = 'Meta fetch failed â ' + message;
                        }
                        setStatusMessage('Meta fetch failed â ' + message);
                        setHandshakeSpinnerActive(false);
                        return;
                    }
                    const mapping = {
                        events: meta && typeof meta.events_ws === 'string' ? meta.events_ws : '',
                        rl: meta && typeof meta.rl_ws === 'string' ? meta.rl_ws : '',
                        logs: meta && typeof meta.logs_ws === 'string' ? meta.logs_ws : ''
                    };
                    websocketChannels.forEach((name) => {
                        const url = mapping[name] || '';
                        if (url) {
                            connectChannel(name, url);
                        } else {
                            setChannelState(name, 'warn', 'No endpoint provided');
                        }
                    });
                }

                updateDataChannelsFromBanner();
                renderConnectionSummary();
                initRunLiveConnectivity();
                bootRealtime();

                const suggestionRows = Array.from(document.querySelectorAll('#suggestions-panel tbody tr'));
                const agentSelect = document.getElementById('suggestion-filter-agent');
                const sideSelect = document.getElementById('suggestion-filter-side');
                const mintInput = document.getElementById('suggestion-filter-mint');
                const mismatchOnly = document.getElementById('suggestion-filter-mismatch');
                const testToggle = document.getElementById('test-mode-toggle');
                const testIndicator = document.getElementById('test-indicator');
                const testLabel = document.getElementById('test-status-label');
                let testTimer = null;
                let testActive = false;

                function populateAgentOptions() {
                    if (!agentSelect) {
                        return;
                    }
                    const agents = new Set();
                    suggestionRows.forEach((row) => {
                        const agent = row.dataset.agent;
                        if (agent) {
                            agents.add(agent);
                        }
                    });
                    agents.forEach((agent) => {
                        const option = document.createElement('option');
                        option.value = agent;
                        option.textContent = agent;
                        agentSelect.appendChild(option);
                    });
                }

                function applySuggestionFilters() {
                    suggestionRows.forEach((row) => {
                        if (row.classList.contains('skeleton-row')) {
                            return;
                        }
                        const agent = row.dataset.agent || '';
                        const side = row.dataset.side || '';
                        const mint = row.dataset.mint || '';
                        const mismatch = row.dataset.mismatch === '1';
                        let visible = true;
                        if (agentSelect && agentSelect.value && agent !== agentSelect.value) {
                            visible = false;
                        }
                        if (visible && sideSelect && sideSelect.value && side !== sideSelect.value) {
                            visible = false;
                        }
                        if (visible && mintInput && mintInput.value) {
                            const needle = mintInput.value.toLowerCase();
                            if (!mint.toLowerCase().includes(needle)) {
                                visible = false;
                            }
                        }
                        if (visible && mismatchOnly && mismatchOnly.checked && !mismatch) {
                            visible = false;
                        }
                        row.style.display = visible ? '' : 'none';
                    });
                }

                function highlightMint(mint) {
                    if (!mint) {
                        return;
                    }
                    const panels = ['#token-facts-panel', '#market-panel', '#golden-panel'];
                    panels.forEach((selector) => {
                        const row = document.querySelector(selector + ' tr[data-mint="' + mint + '"]');
                        if (row) {
                            row.classList.add('highlight');
                            row.scrollIntoView({behavior: 'smooth', block: 'center'});
                            window.setTimeout(() => row.classList.remove('highlight'), 1500);
                        }
                    });
                }

                async function triggerGoldenDemo() {
                    if (!goldenDemoButton || goldenDemoButton.disabled) {
                        return;
                    }
                    const originalLabel = goldenDemoButton.textContent || 'Run Golden Demo';
                    goldenDemoButton.disabled = true;
                    goldenDemoButton.textContent = 'Runningâ¦';
                    setStatusMessage('Golden demo runningâ¦');
                    let finalMessage = '';
                    try {
                        const response = await fetch('/ops/golden-demo', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({source: 'ui'})
                        });
                        if (!response.ok) {
                            finalMessage = 'Golden demo failed: HTTP ' + response.status;
                        } else {
                            const data = await response.json().catch(() => ({}));
                            if (data && data.ok) {
                                const duration = typeof data.duration_s === 'number' ? data.duration_s : null;
                                const artifactDir = data.artifacts_dir ? String(data.artifacts_dir) : '';
                                finalMessage = 'Golden demo PASS';
                                if (duration !== null && Number.isFinite(duration)) {
                                    finalMessage += ' (' + duration.toFixed(1) + 's)';
                                }
                                if (artifactDir) {
                                    finalMessage += ' â artifacts @ ' + artifactDir;
                                }
                                if (typeof console !== 'undefined') {
                                    if (data.stdout) {
                                        console.log('golden-demo stdout', data.stdout);
                                    }
                                    if (data.stderr) {
                                        console.log('golden-demo stderr', data.stderr);
                                    }
                                }
                            } else {
                                const detail = data && data.error ? String(data.error) : 'failed';
                                finalMessage = 'Golden demo failed: ' + detail;
                                if (data && data.stderr && typeof console !== 'undefined') {
                                    console.log('golden-demo stderr', data.stderr);
                                }
                            }
                        }
                    } catch (err) {
                        const detail = err && err.message ? err.message : 'unknown error';
                        finalMessage = 'Golden demo failed: ' + detail;
                    } finally {
                        if (!finalMessage) {
                            finalMessage = 'Golden demo complete';
                        }
                        setStatusMessage(finalMessage);
                        goldenDemoButton.disabled = false;
                        goldenDemoButton.textContent = originalLabel;
                    }
                }

                const panelsToCheck = [
                    'discovery-panel',
                    'token-facts-panel',
                    'market-panel',
                    'golden-panel',
                    'suggestions-panel',
                    'vote-panel',
                    'shadow-panel',
                    'rl-panel'
                ];

                function panelHasData(panelId) {
                    const panel = document.getElementById(panelId);
                    if (!panel) {
                        return false;
                    }
                    const rows = panel.querySelectorAll('tbody tr');
                    for (const row of rows) {
                        if (row.classList.contains('skeleton-row')) {
                            continue;
                        }
                        if (row.style.display === 'none') {
                            continue;
                        }
                        if (row.dataset && row.dataset.mint) {
                            return true;
                        }
                        if (row.textContent && row.textContent.trim() && !row.classList.contains('muted')) {
                            return true;
                        }
                    }
                    return false;
                }

                function updateTestIndicator() {
                    if (!testIndicator || !testLabel) {
                        return;
                    }
                    const ready = panelsToCheck.every((panelId) => panelHasData(panelId));
                    if (ready) {
                        testIndicator.classList.remove('waiting');
                        testIndicator.classList.add('ok');
                        testLabel.textContent = 'UI OK';
                    } else {
                        testIndicator.classList.remove('ok');
                        testIndicator.classList.add('waiting');
                        testLabel.textContent = 'Waitingâ¦';
                    }
                }

                function setTestMode(active) {
                    testActive = active;
                    if (!testIndicator || !testLabel) {
                        return;
                    }
                    if (testActive) {
                        testIndicator.classList.add('waiting');
                        testIndicator.classList.remove('ok');
                        testLabel.textContent = 'Checkingâ¦';
                        updateTestIndicator();
                        if (testTimer) {
                            window.clearInterval(testTimer);
                        }
                        testTimer = window.setInterval(updateTestIndicator, 2000);
                    } else {
                        if (testTimer) {
                            window.clearInterval(testTimer);
                            testTimer = null;
                        }
                        testIndicator.classList.remove('ok');
                        testIndicator.classList.add('waiting');
                        testLabel.textContent = 'Off';
                    }
                }

                populateAgentOptions();
                applySuggestionFilters();

                if (agentSelect) {
                    agentSelect.addEventListener('change', applySuggestionFilters);
                }
                if (sideSelect) {
                    sideSelect.addEventListener('change', applySuggestionFilters);
                }
                if (mintInput) {
                    mintInput.addEventListener('input', applySuggestionFilters);
                }
                if (mismatchOnly) {
                    mismatchOnly.addEventListener('change', applySuggestionFilters);
                }

                if (goldenDemoButton) {
                    goldenDemoButton.addEventListener('click', triggerGoldenDemo);
                }
                if (testToggle) {
                    testToggle.addEventListener('click', function () {
                        setTestMode(!testActive);
                    });
                }
                navLinks.forEach((link) => {
                    link.addEventListener('click', (event) => {
                        const targetKey = link.dataset.target || '';
                        const targetEl = navTargets[targetKey] || document.querySelector(link.getAttribute('href'));
                        if (targetEl) {
                            event.preventDefault();
                            targetEl.scrollIntoView({behavior: 'smooth', block: 'start'});
                            highlightNav(targetKey);
                        }
                    });
                });
                initNavObserver();
                updateStatusClock();
                window.setInterval(updateStatusClock, 1000);

                document.addEventListener('click', function (event) {
                    const btn = event.target.closest('.flatten-btn');
                    if (btn) {
                        event.preventDefault();
                        const mint = btn.dataset.mint;
                        if (!mint) {
                            return;
                        }
                        fetch('/actions/flatten', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({mint: mint, must: true, must_exit: true})
                        }).catch(() => {});
                        return;
                    }
                    const mintChip = event.target.closest('.mint-chip');
                    if (mintChip) {
                        event.preventDefault();
                        highlightMint(mintChip.dataset.mint || '');
                        return;
                    }
                    const discoveryRow = event.target.closest('#discovery-panel tbody tr[data-mint]');
                    if (discoveryRow) {
                        const mint = discoveryRow.dataset.mint;
                        if (mint) {
                            highlightMint(mint);
                        }
                    }
                });

                highlightNav('overview');
                // Initialise indicator state
                setTestMode(false);
            })();
        </script>
</body>
</html>


